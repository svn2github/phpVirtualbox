<!--

	VM Port Settings
	Copyright (C) 2010-2012 Ian Moore (imoore76 at yahoo dot com)
	
	$Id$
	
-->
<ul id='vboxSettingsPortTypeList'>
	<li><a href='#vboxSettingsTabPortsSerial'><img src='images/vbox/serial_port_16px.png' /><span class='translate'>Serial Ports</span></a></li>
	<li><a href='#vboxSettingsTabPortsParallel'><img src='images/vbox/parallel_port_16px.png' /><span class='translate'>Parallel Ports</span></a></li>
	<li><a href='#vboxSettingsTabPortsUSB'><img src='images/vbox/usb_16px.png' /><span class='translate'>USB</span></a></li>
</ul>
<div id='vboxSettingsTabPortsSerial'>

	<div id='vboxSettingsTabSerialPortContainer'>

		<div id='vboxSettingsTabSerialPort' style='display: none'>
		<table class='vboxVertical'>
			<tr>
				<td colspan='2'><label><input name='vboxSettingsSPortEnabled' class='vboxCheckbox vboxEnablerCheckbox' type='checkbox' /> <span class='translate'>Enable Serial Port</span></label></td>
			</tr>
			<tr>
				<th style='min-width: 120px'><span class='translate'>Port Number:</span></th>
				<td class='vboxEnablerTrigger'>
					<select style='width: auto' name='vboxSettingsPortNumber' onchange='vboxSettingsUpdateSPortOptions(this);'>
						<option value='COM1'>COM1</option>
						<option value='COM2'>COM2</option>
						<option value='COM3'>COM3</option>
						<option value='COM4'>COM4</option>
						<option value='User-defined' class='translate'>User-defined</option>	
					</select>
					<span class='vboxEnablerListen'><span class='translate'>IRQ:</span></span> <input type='text' name='vboxSettingsSPortIRQ' size='2' disabled='disabled' />
					<span class='vboxEnablerListen'><span class='translate'>I/O Port:</span></span> <input type='text' name='vboxSettingsSPortIO' size='5' disabled='disabled' />
		        </td>
			</tr>
			<tr>
				<th><span class='translate'>Port Mode:</span></th>
				<td class='vboxEnablerTrigger'>
					<select style='width: auto' name='vboxSettingsPortMode' onchange='vboxSettingsUpdateSPortMode(this);'>
						<option value='Disconnected' >Disconnected</option>
						<option value='HostPipe' >HostPipe</option>
						<option value='HostDevice' >HostDevice</option>
						<option value='RawFile' >RawFile</option>
					</select>
		          </td>
			</tr>
			<tr>
				<th></th>
				<td>
					<label><input type='checkbox' class='vboxCheckbox vboxSettingsSPortCreatePipe' name='vboxSettingsSPortCreatePipe' />
					<span class='translate vboxEnablerListen'>Create Pipe</span></label>
				</td>
			</tr>
			<tr>
				<th class='vboxSPortPathLabel'><span class='translate'>Port/File Path:</span></th>
				<td>
					<input type='text' class='vboxText vboxSPortPathBox' style='width: 100%' name='vboxSettingsSPortPath'/>
				</td>
			</tr>
		</table>
		</div>
	</div>
</div>

<!-- Parallel -->
<div id='vboxSettingsTabPortsParallel'>

	<div id='vboxSettingsTabParallelPortContainer'>
	
		<div id='vboxSettingsTabParallelPort'>
		<table class='vboxVertical'>
			<tr>
				<td colspan='2'><label><input name='vboxSettingsPPortEnabled' class='vboxCheckbox vboxEnablerCheckbox' type='checkbox' /> <span class='translate'>Enable Parallel Port</span></label></td>
			</tr>
			<tr>
				<th style='min-width: 120px'><span class='translate'>Port Number:</span></th>
				<td class='vboxEnablerTrigger'>
					<select style='width: auto' name='vboxSettingsPPortNumber' onchange='vboxSettingsUpdatePPortOptions(this);'>
						<option value='LPT1'>LPT1</option>
						<option value='LPT2'>LPT2</option>
						<option value='LPT3'>LPT3</option>
						<option value='User-defined' class='translate'>User-defined</option>	
					</select>
					<span class='translate'>IRQ:</span> <input type='text' name='vboxSettingsPPortIRQ' size='2' disabled='disabled' />
					<span class='translate'>I/O Port:</span> <input type='text' name='vboxSettingsPPortIO' size='5' disabled='disabled' />
		        </td>
			</tr>
			<tr>
				<th class='vboxPPortPathLabel'><span class='translate'>Port Path:</span></th>
				<td>
					<input type='text' class='vboxText vboxPPortPathBox' style='width: 100%' name='vboxSettingsPPortPath'/>
				</td>
			</tr>
		</table>
		</div>
	</div>
</div>

<!-- USB -->
<div id='vboxSettingsTabPortsUSB'>

	<table id='vboxSettingsUSBTable' style='width: 100%'>
		<tr>
			<td><label><input type='checkbox' class='vboxCheckbox vboxEnablerCheckbox' name='vboxSettingsUSBEnabled' /> <span class='translate'>Enable USB Controller</span></label></td>
		</tr>
		<tr>
			<td style='width: 100%; padding-left: 20px;'><label><input type='checkbox' class='vboxCheckbox' name='vboxSettingsUSBEnabledEHCI' /> <span class='translate vboxEnablerListen'>Enable USB 2.0 (EHCI) Controller</span></label></td>
		</tr>
		<tr style='vertical-align: middle' class='vboxRunningEnabled'>
			<td style='width: 100%; padding-left: 20px;'>
				<table class='vboxSettingsHeadingLine' style='width:100%;border-spacing:0;border:0px;margin:0px;padding:0px;'><tr style='vertical-align:middle' class='vboxRunningEnabled'><td style='white-space: nowrap; width: auto'><span class='translate vboxEnablerListen'>USB Device Filters</span></td><td style='width: 100%'><hr style='width: 100%;'  class='vboxSeperatorLine'/></td></tr></table>
			</td>
		</tr>
		<tr class='vboxRunningEnabled'>
			<td style='width: 100%; padding-left: 20px;'>
			<table style='width: 100%'>
				<tr class='vboxRunningEnabled'>
					<td id='vboxSettingsUSBFilters' style='width: 100%;' class='vboxBordered vboxEnablerListen'>
						<ul id='vboxSettingsUSBFilterList' class='vboxList vboxHover' style='width: 100%'>
							<li class='vboxListItem'><input type='checkbox' class='vboxCheckbox' />a</li>
						</ul>
					</td>
					<td id='vboxSettingsUSBButtons' class='vboxEnablerListen'></td>
				</tr>
			</table>
			</td>
		</tr>
	
	</table>
</div>

<script type='text/javascript'>


/*
 * 
 * Setup data for serial port options
 *
 */
  
var vboxSettingsSPortTemplate = document.getElementById('vboxSettingsTabSerialPort');
var vboxSettingsSPortContainer = $(vboxSettingsSPortTemplate).parent();

/* translated select values */
for(var i = 0; i < document.forms['frmVboxSettings'].vboxSettingsPortNumber.options.length; i++) {
	if($(document.forms['frmVboxSettings'].vboxSettingsPortNumber.options[i]).hasClass('translate'))
		$(document.forms['frmVboxSettings'].vboxSettingsPortNumber.options[i]).text(trans(document.forms['frmVboxSettings'].vboxSettingsPortNumber.options[i].text,'VBoxGlobal')).removeClass('translate');
}
for(var i = 0; i < document.forms['frmVboxSettings'].vboxSettingsPortMode.options.length; i++) {
	document.forms['frmVboxSettings'].vboxSettingsPortMode.options[i].text = trans(vboxSerialMode(document.forms['frmVboxSettings'].vboxSettingsPortMode.options[i].text),'VBoxGlobal');
}

// Translations
$('#vboxSettingsTabSerialPort').find(".translate").html(function(i,h){return trans($('<div />').html(h).text(),'UIMachineSettingsSerial');}).removeClass('translate');

/* Serial Port tab links */
var ul = $('<ul />');
$(vboxSettingsSPortContainer).append(ul);

for(var i = 0; i < parseInt($('#vboxPane').data('vboxSystemProperties').serialPortCount); i++) {

	
	/* tab */
	ul.append($('<li />').html('<a href="#' + vboxSettingsSPortTemplate.id + (i + 1) +'"><span>' + trans('Port %1','UIMachineSettingsSerial').replace('%1',i + 1) + '</span></a>'));

	/* tab content */
	var newTab = $("#vboxSettingsTabSerialPort").clone(true);
	newTab.attr({'id':vboxSettingsSPortTemplate.id + (i + 1)}).css({'display':'block'}).find('.vboxEnablerTrigger').bind('enable',function(){
		$(this).find('select').trigger('change');
	});
	
	newTab.appendTo(vboxSettingsSPortContainer);

	/* Form elements must be unique */
	$("#vboxSettingsTabSerialPort" + (i + 1)).find('[name]').each(function() {
		$(this).attr('name',$(this).attr('name') + (i + 1));
	});

}


/* Remove Template */
$("#vboxSettingsTabSerialPort").empty().remove();

/* Port values */
for(var i = 0; i < parseInt($('#vboxSettingsDialog').data('vboxMachineData').serialPorts.length); i++) {

	var a = (i + 1); 
	
	if(a > $('#vboxPane').data('vboxSystemProperties').serialPortCount) continue;

	// Port Number
	var pNum = vboxSerialPorts.getPortName($('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].IRQ,$('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].IOBase);
	$(document.forms['frmVboxSettings'].elements['vboxSettingsPortNumber'+a]).val(pNum);
	$(document.forms['frmVboxSettings'].elements['vboxSettingsPortNumber'+a].options[document.forms['frmVboxSettings'].elements['vboxSettingsPortNumber'+a].selectedIndex]).attr('selected','selected');
	$(document.forms['frmVboxSettings'].elements['vboxSettingsPortNumber'+a]).change();	

	$(document.forms['frmVboxSettings'].elements['vboxSettingsSPortIRQ'+a]).val($('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].IRQ);
	$(document.forms['frmVboxSettings'].elements['vboxSettingsSPortIO'+a]).val($('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].IOBase);

	// Port Mode
	$(document.forms['frmVboxSettings'].elements['vboxSettingsPortMode'+a]).val($('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].hostMode);
	$(document.forms['frmVboxSettings'].elements['vboxSettingsPortMode'+a].options[document.forms['frmVboxSettings'].elements['vboxSettingsPortMode'+a].selectedIndex]).attr('selected','selected');
	$(document.forms['frmVboxSettings'].elements['vboxSettingsPortMode'+a]).change();

	// Create pipe 
	document.forms['frmVboxSettings'].elements['vboxSettingsSPortCreatePipe'+a].checked = ($('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].server ? true : false);
	
	// Path
	$(document.forms['frmVboxSettings'].elements['vboxSettingsSPortPath'+a]).val($('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].path);
	
	// Enabled port
	if($('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].enabled) {
		document.forms['frmVboxSettings'].elements['vboxSettingsSPortEnabled'+a].checked = true;
	}

}

// Tell jQuery to set up tabs
$(vboxSettingsSPortContainer).tabs();

/*
 * Called when serial port options change
 */
function vboxSettingsUpdateSPortOptions(sel) {

	// IRQ and IO text boxes
	if(sel.value == 'User-defined') {
		$(sel).siblings('input').prop('disabled',false);
		$(sel).siblings('span').removeClass('vboxDisabled');
	} else {
		$(sel).siblings('input').prop('disabled',true);
		$(sel).siblings('span').addClass('vboxDisabled');
		for(var i = 0; i < vboxSerialPorts.ports.length; i++) {
			if(vboxSerialPorts.ports[i].name == sel.value) {
				$(sel).siblings('input').first().val(vboxSerialPorts.ports[i].irq);
				$(sel).siblings('input').last().val(vboxSerialPorts.ports[i].port);
				return;
			}
		}
	}
}

/*
 * When serial port mode changes
 */
function vboxSettingsUpdateSPortMode(sel) {
	var ptable = $(sel).closest('table');
	if(sel.value == 'HostPipe') {
		ptable.find('input.vboxSettingsSPortCreatePipe').prop({'disabled':false}).siblings().removeClass('vboxDisabled');
	} else {
		ptable.find('input.vboxSettingsSPortCreatePipe').prop({'disabled':true}).siblings().addClass('vboxDisabled');
	}
	if(sel.value == 'Disconnected') {
		ptable.find('.vboxSPortPathLabel').addClass('vboxDisabled');
		ptable.find('.vboxSPortPathBox').prop('disabled',true);
	} else {
		ptable.find('.vboxSPortPathLabel').removeClass('vboxDisabled');
		ptable.find('.vboxSPortPathBox').prop('disabled',false);
	}
}


/* Disable non-editable items when VM is running */
$('#vboxSettingsDialog').one('show',function(){
	
	if(!$('#vboxSettingsDialog').data('vboxFullEdit')) {
		
		vboxSettingsSPortContainer.find('span').addClass('disabled');
		vboxSettingsSPortContainer.find('input,select,textarea').prop('disabled',true);

	}
});

/* Change settings onSave() */
$('#vboxSettingsDialog').bind('save',function(){

	/* Net */
	for(var i = 0; i < parseInt($('#vboxPane').data('vboxSystemProperties').serialPortCount); i++) {

		var a = (i + 1); 

		// Port IRQ and IO
		$('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].IRQ = $(document.forms['frmVboxSettings'].elements['vboxSettingsSPortIRQ'+a]).val();
		$('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].IOBase = $(document.forms['frmVboxSettings'].elements['vboxSettingsSPortIO'+a]).val();

		// Port Mode
		$('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].hostMode = $(document.forms['frmVboxSettings'].elements['vboxSettingsPortMode'+a]).val(); 

		// Create pipe 
		$('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].server = (document.forms['frmVboxSettings'].elements['vboxSettingsSPortCreatePipe'+a].checked ? 1 : 0);
		
		// Path
		$('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].path = $(document.forms['frmVboxSettings'].elements['vboxSettingsSPortPath'+a]).val();
		
		// Enabled port
		$('#vboxSettingsDialog').data('vboxMachineData').serialPorts[i].enabled = (document.forms['frmVboxSettings'].elements['vboxSettingsSPortEnabled'+a].checked ? 1 : 0);


	}

});


/*
 * 
 * Setup data for parallel port options
 *
 */
if($('#vboxPane').data('vboxConfig').enableLPTConfig) {
	
	var vboxSettingsPPortTemplate = document.getElementById('vboxSettingsTabParallelPort');
	var vboxSettingsPPortContainer = $(vboxSettingsPPortTemplate).parent();
	
	/* translated select values */
	for(var i = 0; i < document.forms['frmVboxSettings'].vboxSettingsPPortNumber.options.length; i++) {
		if($(document.forms['frmVboxSettings'].vboxSettingsPPortNumber.options[i]).hasClass('translate'))
			$(document.forms['frmVboxSettings'].vboxSettingsPPortNumber.options[i]).text(trans(document.forms['frmVboxSettings'].vboxSettingsPPortNumber.options[i].text,'VBoxGlobal')).removeClass('translate');
	}
	
	//Translations
	$('#vboxSettingsTabParallelPort').find(".translate").html(function(i,h){return trans($('<div />').html(h).text(),'UIMachineSettingsParallel');}).removeClass('translate');
	
	
	
	/* Parallel Port tab links */
	var ul = $('<ul />');
	$(vboxSettingsPPortContainer).append(ul);
	
	for(var i = 0; i < parseInt($('#vboxPane').data('vboxSystemProperties').parallelPortCount); i++) {
	
		
		/* tab */
		ul.append($('<li />').html('<a href="#' + vboxSettingsPPortTemplate.id + (i + 1) +'"><span>' + trans('Port %1','UIMachineSettingsParallel').replace('%1',i + 1) + '</span></a>'));
	
		/* tab content */
		var newTab = $("#vboxSettingsTabParallelPort").clone(true);
		newTab.attr('id',vboxSettingsPPortTemplate.id + (i + 1));
		newTab.css('display','block');
	
		// Enable / disable trigger
		newTab.find('.vboxEnablerTrigger').bind('enable',function(){
			$(this).children('select').trigger('change');
		});
		
		newTab.appendTo(vboxSettingsPPortContainer);
	
		/* Form elements must be unique */
		$("#vboxSettingsTabParallelPort" + (i + 1)).find('[name]').each(function() {
			$(this).attr('name',$(this).attr('name') + (i + 1));
		});
	
	}
	
	
	/* Remove Template */
	$("#vboxSettingsTabParallelPort").empty().remove();
	
	/* Port values */
	for(var i = 0; i < parseInt($('#vboxSettingsDialog').data('vboxMachineData').parallelPorts.length); i++) {
	
		var a = (i + 1); 
		
		if(a > $('#vboxPane').data('vboxSystemProperties').parallelPortCount) continue;
	
		// Port Number
		var pNum = vboxParallelPorts.getPortName($('#vboxSettingsDialog').data('vboxMachineData').parallelPorts[i].IRQ,$('#vboxSettingsDialog').data('vboxMachineData').parallelPorts[i].IOBase);
		$(document.forms['frmVboxSettings'].elements['vboxSettingsPPortNumber'+a]).val(pNum);
		$(document.forms['frmVboxSettings'].elements['vboxSettingsPPortNumber'+a].options[document.forms['frmVboxSettings'].elements['vboxSettingsPPortNumber'+a].selectedIndex]).attr('selected','selected');
		$(document.forms['frmVboxSettings'].elements['vboxSettingsPPortNumber'+a]).change();	
	
		$(document.forms['frmVboxSettings'].elements['vboxSettingsPPortIRQ'+a]).val($('#vboxSettingsDialog').data('vboxMachineData').parallelPorts[i].IRQ);
		$(document.forms['frmVboxSettings'].elements['vboxSettingsPPortIO'+a]).val($('#vboxSettingsDialog').data('vboxMachineData').parallelPorts[i].IOBase);
	
		// Path
		$(document.forms['frmVboxSettings'].elements['vboxSettingsPPortPath'+a]).val($('#vboxSettingsDialog').data('vboxMachineData').parallelPorts[i].path);
		
		// Enabled port
		if($('#vboxSettingsDialog').data('vboxMachineData').parallelPorts[i].enabled) {
			document.forms['frmVboxSettings'].elements['vboxSettingsPPortEnabled'+a].checked = true;
		}
	
	}
	
	//Tell jQuery to set up tabs
	$(vboxSettingsPPortContainer).tabs();
	

	
// No LPT config
} else {
	$('#vboxSettingsPortTypeList').children('li:eq(1)').empty().remove();
	$('#vboxSettingsTabPortsParallel').empty().remove();
}

/*
 * Called when parallel port options change
 */
function vboxSettingsUpdatePPortOptions(sel) {

	// IRQ and IO text boxes
	if(sel.value == 'User-defined') {
		$(sel).siblings('input').prop('disabled',false);
		$(sel).siblings('span').removeClass('vboxDisabled');
	} else {
		$(sel).siblings('input').prop('disabled',true);
		$(sel).siblings('span').addClass('vboxDisabled');
		for(var i = 0; i < vboxParallelPorts.ports.length; i++) {
			if(vboxParallelPorts.ports[i].name == sel.value) {
				$(sel).siblings('input').first().val(vboxParallelPorts.ports[i].irq);
				$(sel).siblings('input').last().val(vboxParallelPorts.ports[i].port);
				return;
			}
		}
	}
}

/* Disable non-editable items when VM is running */
$('#vboxSettingsDialog').one('show',function(){
	
	if($('#vboxPane').data('vboxConfig').enableLPTConfig && !$('#vboxSettingsDialog').data('vboxFullEdit')) {
		
		vboxSettingsPPortContainer.find('span').addClass('disabled');
		vboxSettingsPPortContainer.find('input,select,textarea').prop('disabled',true);

	}
});


/* Change settings onSave() */
$('#vboxSettingsDialog').bind('save',function(){

	if(!$('#vboxPane').data('vboxConfig').enableLPTConfig) return;
	
	for(var i = 0; i < parseInt($('#vboxPane').data('vboxSystemProperties').parallelPortCount); i++) {

		var a = (i + 1); 

		// Port IRQ and IO
		$('#vboxSettingsDialog').data('vboxMachineData').parallelPorts[i].IRQ = $(document.forms['frmVboxSettings'].elements['vboxSettingsPPortIRQ'+a]).val();
		$('#vboxSettingsDialog').data('vboxMachineData').parallelPorts[i].IOBase = $(document.forms['frmVboxSettings'].elements['vboxSettingsPPortIO'+a]).val();

		// Path
		$('#vboxSettingsDialog').data('vboxMachineData').parallelPorts[i].path = $(document.forms['frmVboxSettings'].elements['vboxSettingsPPortPath'+a]).val();
		
		// Enabled port
		$('#vboxSettingsDialog').data('vboxMachineData').parallelPorts[i].enabled = (document.forms['frmVboxSettings'].elements['vboxSettingsPPortEnabled'+a].checked ? 1 : 0);


	}

});



/*
 * USB Buttons and Toolbar
 */
 
//Translations
 $('#vboxSettingsTabPortsUSB').find(".translate").html(function(i,h){return trans($('<div />').html(h).text(),'UIMachineSettingsUSB');}).removeClass('translate');


 var sButtons = new Array(

	{
		'name' : 'usbnew',
		'label' : trans('Add Empty Filter','UIMachineSettingsUSB'),
		'icon' : 'usb_new',
		'click' : function () {
			var currUsbName = 1;
			for(; currUsbName < 99; currUsbName++) {
				if(!$(list).find('span.vboxSettingsUSBFilterTitle').filter(function(){
					return ($(this).text() == trans('New Filter %1','UIMachineSettingsUSB').replace('%1',currUsbName));
				}).length) break;
			}

			vboxSettingsAddUSBFilter({'active':1,'name':trans('New Filter %1','UIMachineSettingsUSB').replace('%1',currUsbName)});

			if(!$('#vboxSettingsUSBFilterList').find('.vboxListItemSelected').first().trigger('click').html()) {
				$('#vboxSettingsUSBFilterList').trigger('select',null);		}
			}
	},

	{
		'name' : 'usbnewdevice',
		'label' : trans('Add Filter From Device','UIMachineSettingsUSB'),
		'icon' : 'usb_add',
		'click' : function (e) {

			// Update menu
			var menu = $("#vboxSettingsUSBAddDevice");
			
			menu.children().remove();		
			menu.append($('<li />').html('<span><img src="images/jqueryFileTree/spinner.gif" /></span>').css({'width':'100px','text-align':'center'}));
			
			var l = new vboxLoader();
			l.add('hostGetUSBDevices',function(res){
				
				var hostUSB = res.responseData;
				
				$(menu).children().remove();
				for(var i = 0; i < hostUSB.length; i++) {

					var dname = '';
					if(!hostUSB[i].product)
						dname = trans('Unknown device %1:%2','VBoxGlobal').replace('%1',hostUSB[i].vendorId).replace('%2',hostUSB[i].productId);
					else
						dname = hostUSB[i].manufacturer + ' ' + hostUSB[i].product;
					dname += ' [' + hostUSB[i].revision + ']';
					
					$(menu).append($('<li />').append($('<a />').attr({'href':'#usbDev'+i}).html(dname).data({'device':hostUSB[i]})));
				}
				
				// No devices?
				if(hostUSB.length == 0) {
					$(menu).append($('<li />').append($('<a />').attr({'href':'#usbNoop'}).html($('<div />').text(trans('<no devices available>','VBoxUSBMenu')).html()).data({'device':hostUSB[i]})));
				}
				$(menu).trigger('menuLoaded');
				
				vboxPositionToWindow(menu);
				
			},{});
			l.noLoadingScreen = true;
			l.run();

			// Trigger mouse up / down on hidden element
			
			var md = jQuery.Event("mousedown");
			var mu = jQuery.Event("mouseup");
			for(var i in e) { (md[i] ? null : md[i] = mu[i] = e[i]); }
			// Fix mouse button for MSIE
			if(jQuery.browser.msie && e.button == 0) md.button = mu.button = 1;
			
			
			$("#vboxSettingsUSBAddDeviceClick").trigger(md).trigger(mu);
		}		
	},
	
	{
		'name' : 'usbedit',
		'label' : trans('Edit Filter','UIMachineSettingsUSB'),
		'icon' : 'usb_filter_edit',
		'enabled' : function (item) { return (item && $(item).data('filter') && $(item).data('filter').name); },
		'click' : function () {

          	var d = $('<div />').attr({'id':'vboxSettingsUSBFilterEdit','style':'display: none','class':'vboxNonTabbed vboxDialogContent'});

          	var tbl = $('<table />').attr({'style':'width: 100%','class':'vboxSettingsTable'});
          	
			var vboxSettingsUSBFilterProps = [
				['Name','name'],['Vendor ID','vendorId'],['Product ID','productId'],
				['Revision','revision'],['Manufacturer','manufacturer'],['Product','product'],
				['Serial No.','serialNumber'],['Port','port']];
			
			/* Get Defaults */
			var filter = $('#vboxSettingsUSBFilterList').find('li.vboxListItemSelected').first().data('filter');

          	for(var i = 0; i < vboxSettingsUSBFilterProps.length; i++) {
              	
          		var val = (filter[vboxSettingsUSBFilterProps[i][1]]||'');
          		$('<tr />').append($('<th />').attr({'style':'white-space: nowrap; width: auto; text-align: right;'}).html(trans(vboxSettingsUSBFilterProps[i][0]+':','UIMachineSettingsUSBFilterDetails'))).append($('<td />').attr({'style':'width: 100%'}).html('<input type="text" class="vboxText" style="width: 100%" id="vboxSettingsUSBF'+vboxSettingsUSBFilterProps[i][1]+'" value="'+$('<div />').text((filter[vboxSettingsUSBFilterProps[i][1]]||'')).html()+'"/>')).appendTo(tbl);
          	}
          	
          	// Generate select box
          	var sel = $('<select />').attr({'id':'vboxSettingsUSBFRemote'});
          	var opts = [['',trans('Any','UIMachineSettingsUSBFilterDetails')],['yes',trans('Yes','UIMachineSettingsUSBFilterDetails')],['no',trans('No','UIMachineSettingsUSBFilterDetails')]];
          	for(var i = 0; i < opts.length; i++) {
              	var o = new Option(opts[i][1],opts[i][0],((filter['remote']||'')==opts[i][0]));
              	$(sel).prop('options').add(o);
          	}
          	
          	$('<tr />').append($('<th />').attr({'style':'white-space: nowrap; width: auto; text-align: right;'}).html(trans('Remote:','UIMachineSettingsUSBFilterDetails'))).append($('<td />').attr({'style':'width: 100%'}).append(sel)).appendTo(tbl);
          	
          	$(d).append(tbl).appendTo($('#vboxPane'));
          	
			var buttons = { };
			buttons[trans('OK','QIMessageBox')] = function() {

				var item = $('#vboxSettingsUSBFilterList').find('.vboxListItemSelected').first();

				for(var i = 0; i < vboxSettingsUSBFilterProps.length; i++) {
					$(item).data('filter')[vboxSettingsUSBFilterProps[i][1]] = $('#vboxSettingsUSBF'+(vboxSettingsUSBFilterProps[i][1])).val();
				}
				$(item).data('filter').remote = ($('#vboxSettingsUSBFRemote').val()||'');
				// Change display name
				$(item).find('span.vboxSettingsUSBFilterTitle').first().text($(item).data('filter').name);
				$('#vboxSettingsUSBFilterEdit').remove();
			};
			buttons[trans('Cancel','QIMessageBox')] = function() { $('#vboxSettingsUSBFilterEdit').remove(); };

			                  			
          	$('#vboxSettingsUSBFilterEdit').dialog({'buttons':buttons,'closeOnEscape':false,'width':400,'modal':true,'autoOpen':true,'stack':true,'dialogClass':'vboxDialogContent vboxNonTabbed','title':'<img src="images/vbox/usb_16px.png" class="vboxDialogTitleIcon" /> '+trans('USB Filter Details','UIMachineSettingsUSBFilterDetails')});
			
		}		
	},

	{
		'name' : 'usbremove',
		'label' : trans('Remove Filter','UIMachineSettingsUSB'),
		'icon' : 'usb_remove',
		'enabled' : function (item) { return (item && $(item).data('filter') && $(item).data('filter').name); },
		'click' : function () {
			var item = $('#vboxSettingsUSBFilterList').find('.vboxListItemSelected').first();
			// determine next target
			var target = $(item).next();
			if(!$(target).length) target = $(item).prev();
			if(!$(target).length) target = $('#vboxSettingsUSBFilterList').children().first();
			$(item).remove();

			if(!$(target).trigger('click').length) {
				$('#vboxSettingsUSBFilterList').trigger('select',null);
			}
			vboxColorRows($('#vboxSettingsUSBFilterList'));
		}		
	},
	
	{
		'name' : 'usbup',
		'label' : trans('Move Filter Up','UIMachineSettingsUSB'),
		'icon' : 'usb_moveup',
		'enabled' : function (item) {
			return (item && $(item).data('filter') && $(item).data('filter').name && $(item).attr('id') != $('#vboxSettingsUSBFilterList').children().first().attr('id'));
		},
		'click' : function () {

			var item = $('#vboxSettingsUSBFilterList').find('.vboxListItemSelected').first();

			var prev = $(item).prev();
			if(!$(prev).length) return;
			var mv = $(item).detach();
			$(prev).before(mv);

			vboxColorRows($('#vboxSettingsUSBFilterList'));
			$('#vboxSettingsUSBFilterList').find('.vboxListItemSelected').first().trigger('click');
			 
		}		
	},
	
	{
		'name' : 'usbdown',
		'label' : trans('Move Filter Down','UIMachineSettingsUSB'),
		'icon' : 'usb_movedown',
		'enabled' : function (item) {
			return (item && $(item).data('filter') && $(item).data('filter').name && $(item).attr('id') != $('#vboxSettingsUSBFilterList').children().last().attr('id'));
		},
		'click' : function () {
			
			var item = $('#vboxSettingsUSBFilterList').find('.vboxListItemSelected').first();

			var next = $(item).next();
			if(!$(next).length) return;
			var mv = $(item).detach();
			$(next).after(mv);
			
			vboxColorRows($('#vboxSettingsUSBFilterList'));
			$('#vboxSettingsUSBFilterList').find('.vboxListItemSelected').first().trigger('click');
		}
	}
		
			
 );

var usbToolbar = new vboxToolbarSmall(sButtons);
usbToolbar.addButtons('vboxSettingsUSBButtons');

$('#vboxSettingsUSBFilterList').bind('select',function(e,el){usbToolbar.update(el);});



/* Adds a USB filter to list */
function vboxSettingsAddUSBFilter(f,noColor) {
	
	var li = $('<li />').data({'filter':f}).attr({'id':'vboxSettingsUSBFilterNumber' + (Math.floor(Math.random()*1000)),'class':'vboxListItem'});
	
	if(document.forms['frmVboxSettings'].vboxSettingsUSBEnabled.checked) {
		
		li.click(function(){
			$(this).parent().children().removeClass('vboxListItemSelected');
			$(this).addClass('vboxListItemSelected');
			$('#vboxSettingsUSBFilterList').trigger('select',this);
		}).dblclick(function(e){
			e.preventDefault();
			usbToolbar.click('usbedit');
		}).hover(function(){$(this).addClass('vboxHover');},function(){$(this).removeClass('vboxHover');}).disableSelection();
	}
	
	$('<input />').attr({'type':'checkbox'}).prop('checked',(f.active ? true : false)).appendTo(li);
	
	$(li).append(' <span class="vboxSettingsUSBFilterTitle">'+$('<div/>').text(f.name).html()+'</span>').appendTo($('#vboxSettingsUSBFilterList'));

	
	if(!noColor) vboxColorRows($('#vboxSettingsUSBFilterList'));
}

// set checkboxes for USB and EHCI
document.forms['frmVboxSettings'].vboxSettingsUSBEnabled.checked = ($('#vboxSettingsDialog').data('vboxMachineData').USBController.enabled);
document.forms['frmVboxSettings'].vboxSettingsUSBEnabledEHCI.checked = ($('#vboxSettingsDialog').data('vboxMachineData').USBController.enabledEHCI);

// clear list
var list = $('#vboxSettingsUSBFilterList');
$(list).children().remove();

// add filters
for(var i = 0; i < $('#vboxSettingsDialog').data('vboxMachineData').USBController.deviceFilters.length; i++) {
	vboxSettingsAddUSBFilter($('#vboxSettingsDialog').data('vboxMachineData').USBController.deviceFilters[i],true);
}
vboxColorRows($('#vboxSettingsUSBFilterList'));


if(!$('#vboxSettingsUSBFilterList').find('li.vboxListItem').first().trigger('click')) {
	$('#vboxSettingsUSBFilterList').trigger('select',null);
}


/* Menu for adding existing USB device */
if($('#vboxSettingsUSBAddDevice').attr('id')) {
	$('#vboxSettingsUSBAddDevice').empty();
} else {
	$('#vboxPane').append($('<ul />').attr({'class':'contextMenu contextMenuNoBG','style':'display: none','id':'vboxSettingsUSBAddDevice'}));
}

/* Hidden element that menu is bound to */
if(!$('#vboxSettingsUSBAddDeviceClick').attr('id')) {
	
	$('#vboxSettingsUSBFilters').append($('<div />').attr({'style':'display: none','id':'vboxSettingsUSBAddDeviceClick'}));
}

/* Add attachment button menu initialization  */
$("#vboxSettingsUSBAddDeviceClick").contextMenu({
		menu: 'vboxSettingsUSBAddDevice',
		button: 0
	},
	function(action, el, pos, menuItem) {

		if(action == 'usbNoop') return;

		// usb data kept in elm
		var usb = $(menuItem).data('device');
		delete usb.port, usb.version, usb.portVersion;
		usb.name = $(menuItem).html();
		usb.active = 1;
		
		vboxSettingsAddUSBFilter(usb);
		
		$('#vboxSettingsUSBFilterList').trigger('select',$('#vboxSettingsUSBFilterList').find('.vboxListItemSelected').first());

	}
);


/* Disable non-editable items when VM is running */
$('#vboxSettingsDialog').one('show',function(){
	
	if(!$('#vboxSettingsDialog').data('vboxFullEdit')) {
		
		var p = $('#vboxSettingsUSBTable');
		$(p).find('tr:not(.vboxRunningEnabled)').find('span').addClass('disabled');
		$(p).find('tr:not(.vboxRunningEnabled)').find('input,select,textarea').prop('disabled',true);

	}
});


/* Change settings onSave() */
$('#vboxSettingsDialog').bind('save',function(){

	
	$('#vboxSettingsDialog').data('vboxMachineData').USBController.enabled = (document.forms['frmVboxSettings'].vboxSettingsUSBEnabled.checked ? 1 : 0);
	$('#vboxSettingsDialog').data('vboxMachineData').USBController.enabledEHCI = (document.forms['frmVboxSettings'].vboxSettingsUSBEnabledEHCI.checked ? 1 : 0);

	$('#vboxSettingsDialog').data('vboxMachineData').USBController.deviceFilters = new Array();

	$('#vboxSettingsUSBFilterList').children('li').each(function(){
		$(this).data('filter').active = ($(this).children('input:checkbox').first().prop('checked') ? 1 : 0);
		$('#vboxSettingsDialog').data('vboxMachineData').USBController.deviceFilters[$('#vboxSettingsDialog').data('vboxMachineData').USBController.deviceFilters.length] = $(this).data('filter');
	});
	
});


</script>
