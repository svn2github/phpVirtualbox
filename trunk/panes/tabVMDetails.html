<!-- 

	VM Details Pane
	Copyright (C) 2010-2012 Ian Moore (imoore76 at yahoo dot com)
	
	$Id$

 -->
<div id='vboxTabVMDetails' style='height: 100%; width: 100%; display: none;' class='vboxInvisible'>
	<div id='vboxVMDetails' style='height: 100%; display: none; min-height:100px;' class='vboxInvisible' />
	
	<!-- Loading... -->
	<div id='vboxDetailsLoading' class='vboxInvisible' style='#position:absolute;#top:50%;display:none;vertical-align:middle;width:100%;height:100%;padding:0px;margin:0px'>
		<div style='#position:relative;#top:-50%;padding:4px;text-align:center;width:100%'>
			<span class='ui-corner-all translate' style='padding:8px;background:#fff;border:2px solid #ddd'>Loading ...</span>
		</div>
	</div>
	<!-- Welcome -->
	<div id='vboxDetailsWelcome' class='vboxBordered' style='#position:absolute;#top:50%;display:none;vertical-align:middle;width:50%;height:50%;text-align:center'>
		<div style='#position:relative;#top:-50%;padding:0px;text-align:center;width:100%'>
			<img src='images/vbox/welcome.png' />
		</div>
	</div>
<script type='text/javascript'>


// Translate loading div
$('#vboxDetailsLoading').find('span.translate').html(trans('Loading ...','UIVMDesktop')).removeClass('translate');


// Listen for events
/////////////////////////////
$('#vboxIndex').bind('vmloading',function(){

	// Clear timers if  set
	if($('#vboxVMDetails').data('vboxPreviewTimer')) {
		window.clearTimeout($('#vboxVMDetails').data('vboxPreviewTimer'));
		$('#vboxVMDetails').data('vboxPreviewTimer', null);
	}
	

	// Hide all tab children first
	$('#vboxTabVMDetails').children().hide();

	if($('#vboxTabVMDetails').css('display') != 'none')
		$('#vboxTabVMDetails').css('display','table');
	
	$('#vboxDetailsLoading').show().css('display','table-cell');


}).bind('vmloaded',function(e,vm){

	// Hide all tab children first
	$('#vboxTabVMDetails').children().hide();
	
	// vboxTabVMDetails
	if(vm && vm.id) {
		
		var targetdiv = $('#vboxVMDetails');

		targetdiv.html('');

		if(vm.id == 'host') {

			// Host data
			__vboxDisplayHostDetailsData(vm, targetdiv);
			
		} else {

			var targ
			// VM Data
			__vboxDisplayDetailsData(vm, false, targetdiv);
			
		}
		
		targetdiv.show();
	
	// No VM selected
	} else {

		// Hide all tab children first
		$('#vboxTabVMDetails').css({'display':'table','width':'100%'}).children().hide();
		
		// Display Welcome div
		$('#vboxDetailsWelcome').show().css('display','table-cell');

	
	}

});

// Hide context menus when hiding tab
$('#vboxTabVMDetails').bind('hide',function(){
	$('ul.contextMenu').hide();
});

$('#vboxTabVMDetails .vboxDetailsTableBoxPreview').css('min-width',$('#vboxIndex').data('vboxConfig')['previewWidth']+'px');

								
// Returns link to settings
function vboxDetailSettingsLink(section) {
	
	if(($('#vboxIndex').data('selectedVM').state == 'Running' || $('#vboxIndex').data('selectedVM').sessionState == 'Unlocked') && $('#vboxIndex').data('selectedVM').state != 'Saved') {
		vboxVMsettingsInit($('#vboxIndex').data('selectedVM').id,function(){$('#vboxIndex').trigger('vmselect',[$('#vboxIndex').data('selectedVM')]);},section);
	}
}


//Base function that returns a table row of machine detail data
//Called from other functions
function __vboxDetailRow(name,value,cssClass,html) {
	
	// convert to strings
	if(typeof(value) == 'undefined') value = '';
	name = ''+name;
	value = ''+value;
	
	
	var tr = $('<tr />').attr({'class':'vboxDetailRow'});
	$('<th />').html(name + (value && value.length && name.length ? ':' : ''))
		.attr({'class':'vboxDetailContent ' + cssClass})
		.appendTo(tr);
	
	$('<td />').attr({'class':'vboxDetailsValue'}).html(value).appendTo(tr);

	return tr;
}

//Draw rows to table
function __vboxDetailAddRows(data, rows, table) {
		
	// Is rows a function?
	if(typeof(rows) == 'function') rows = rows(data);
	
	for(var i = 0; i < rows.length; i++) {
		
		// Check if row has condition
		if(rows[i].condition && !rows[i].condition(data)) continue;
		
		// hold row data
		var rowData = '';
		
		// Check for row attribute
		if(rows[i].attrib) {
			if(!data[rows[i].attrib]) continue
			rowData = data[rows[i].attrib];
		
		// Check for row callback
		} else if(rows[i].callback) {
			rowData = rows[i].callback(data);

		// Static data
		} else {
			rowData = rows[i].data;
		}

		if(rows[i].rawRow) {
			$(table).append(rowData);
		} else {
			$(table).append(__vboxDetailRow(rows[i].title, rowData, 'vboxDetailName' + (rows[i].indented ? 'Indent' : ''), rows[i].html));
		}
		
	}
	
}

function __vboxDrawPreview(fromSelf,state) {

	if(!fromSelf && $('#vboxVMDetails').data('vboxPreviewTimer')) {
		window.clearTimeout($('#vboxVMDetails').data('vboxPreviewTimer'));
		$('#vboxVMDetails').data('vboxPreviewTimer', null);
	}
			
	$(__vboxDrawPreviewImg).empty().remove();
	var w = $('#vboxIndex').data('vboxConfig')['previewWidth'];
	__vboxDrawPreviewImg = new Image();
	__vboxDrawPreviewImg.onload = function(){

	var height = 0;
	var width = 0;
		
		// Error or machine not running
		if(this.height <= 1) {

			$('#vboxDetailsPreviewImg').css({'display':'none'}).attr('src','images/vbox/blank.gif');
			$('#vboxDetailsPreviewVMName').css('display','');
			
			width = $('#vboxIndex').data('vboxConfig')['previewWidth'];
			height = width / $('#vboxIndex').data('vboxConfig')['previewAspectRatio'];
			
			// Clear timer if it is set
			if($('#vboxVMDetails').data('vboxPreviewTimer')) {
				window.clearTimeout($('#vboxVMDetails').data('vboxPreviewTimer'));
				$('#vboxVMDetails').data('vboxPreviewTimer', null);
			}
			
			
		} else {

			// Calculate height based on width
			width = $('#vboxIndex').data('vboxConfig')['previewWidth'];
			factor = width / this.width;
			if(!factor) factor = 1;
			height = this.height * factor;
			
			$('#vboxDetailsPreviewVMName').css('display','none');
			$('#vboxDetailsPreviewImg').css({'display':'','height':height+'px','width':width+'px'});
			
			// IE uses filter
			if($.browser.msie) {
				
				if($('#vboxIndex').data('selectedVM').state == 'Running') {
					
					// Setting background URL keeps image from being requested again, but does not allow us to set
					// the size of the image. This is fine, since the image is returned in the size requested.
					$('#vboxDetailsPreviewImg').css({"filter":""}).parent().css({'background':'url('+this.src+')'});
				
				} else {
					
					// This causes the image to be requested again, but is the only way to size the background image.
					// Saved preview images are not returned in the size requested and must be resized at runtime by
					// the browser.
					$('#vboxDetailsPreviewImg').css({"filter":"progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled='true', src='"+this.src+"', sizingMethod='scale')"}).parent().css({'background':'#000'});
				}
				
			// Webkit based browsers will re-download the image if we just set the image source
			} else if($.browser.webkit) {
				
				$('#vboxDetailsPreviewImg').css({'background-image':'url('+vboxDisplayGetBase64Image(this)+')'});
			
			} else {
				$('#vboxDetailsPreviewImg').css({'background-image':'url('+this.src+')','background-size':(width+1) +'px ' + (height+1)+'px'});
			}
			// Keep refreshing preview if VM is running
			if(state == 'Running') {
				$('#vboxVMDetails').data('vboxPreviewTimer',window.setTimeout(function(){
					__vboxDrawPreview(true, state);
				},$('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"] * 1000));
			}
			
		}
		$('#vboxTabVMDetails .vboxDetailsPreviewWrap').css({'height':height+'px','width':width+'px'});
		$('#vboxTabVMDetails .vboxDetailsTableBoxPreview').find('img.vboxPreviewMonitor').css('width',width+'px');
		$('#vboxTabVMDetails .vboxDetailsTableBoxPreview').find('img.vboxPreviewMonitorSide').css('height',height+'px');
	};

	// Update disabled? State not Running or Saved
	if($('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"] == 0 || (state != 'Running' && state != 'Saved')) {
		__vboxDrawPreviewImg.height = 0;
		__vboxDrawPreviewImg.onload();
	} else {
		// Running VMs get random numbers. Saved are based on last state change.
		// Try to let the browser cache Saved screen shots
		if(state == 'Running') {
			var currentTime = new Date();
			var randid = Math.floor(currentTime.getTime() / 1000);			
		} else {
			var randid = $('#vboxIndex').data('selectedVM').lastStateChange;
		}
		__vboxDrawPreviewImg.src = 'screen.php?width='+(w)+'&vm='+$('#vboxIndex').data('selectedVM').id+'&randid='+randid;
	}

}

// Details section
////////////////////////////
function __vboxCreateDetailsSection(data, sectionName, section) {
	
	if(!section)
		section = vboxVMDetailsSections[sectionName];
	
	var ttemplate = "<img style='float:left;  margin-right: 3px;' src='images/vbox/%1' class='vboxDetailsSectionIcon'/><span style='float:left'><a href=\"javascript:vboxDetailSettingsLink('%2')\">%3</a></span><span class='vboxDetailsUpDnImgSpan' style='float:right' onClick='$(this).parent().trigger(\"dblclick\");' />";

	var vboxDetailsTable = $('<table />').attr({'class':'vboxDetailsTable vboxDetailsTableBox'})
		.append($('<thead />')
			.append($('<tr />').attr({'class':'vboxDetailsHead'})
				.append($('<th />').attr({'class':'vboxDetailsSection','colspan':'2'})
					.append($('<div />')
						.addClass(!((data.sessionState == 'Unlocked' || data.state == 'Running') && data.state != 'Saved') ? 'vboxNoLinks' : '')
						.html(ttemplate.replace('%1',section.icon).replace('%2', section.settingsLink).replace('%3', trans(section.title, (section.translationContext ? section.translationContext : 'UIDetailsPagePrivate'), null, section.translationComment)))
					)
				).disableSelection()
			)
		);

	
	var tbody = $('<tbody />');
	__vboxDetailAddRows(data, section.rows, tbody);
	
	// Class added to last row to aid in rounded corners
	if(section.noFooter) {
		tbody.children().last().addClass('vboxTableLastRow');
	} else {
		tbody.append($('<tr />').addClass('vboxTableLastRow').append($('</td >')).append('<td />'));
	}
	
	vboxDetailsTable.append(tbody);

	var vboxDetailsSection = $('<div />').attr({'class':'vboxDetailsBorder vboxVMDetailsBox'+sectionName})
		.dblclick(function(e){

			vboxSetCookie('vboxSectionCollapse'+$(this).data('sectionName'),
					($(this).hasClass('vboxDetailsSectionCollapsed') ? '' : '1')
			);
			$(this).toggleClass('vboxDetailsSectionCollapsed', 500);

			return false;
		}).hover(function(){$(this).addClass('hover');},
			function(){$(this).removeClass('hover');}
		).disableSelection().data({'sectionName':sectionName});

	if($('#vboxIndex').data('vboxCookies')["vboxSectionCollapse"+sectionName]) {
		vboxDetailsSection.addClass('vboxDetailsSectionCollapsed');
	}
	
	if($('#vboxIndex').data('vboxCookies')["vboxSectionShow"+sectionName] == 0) {
		$(vboxDetailsSection).hide();
	} else {
		$(vboxDetailsSection).show();
	}

	/* Context menu for section ? */
	if(section.contextMenu) {
		
		var menu = section.contextMenu();
				
		$(vboxDetailsSection).mouseup( function(e) {

			$('ul.contextMenu').hide();
			
			if(e.button == 2) {

				$(menu).trigger('beforeshow', data);
				
				vboxPositionEvent(menu, e);
				$(menu).show();
				
				e.preventDefault();
				e.stopPropagation();
				
				return false;
			}
			
		});
		
		$(vboxDetailsSection)
			.bind('contextmenu', function() { return false; })
			.bind('click',function(e){return e.button!=2;});

	}
	return vboxDetailsSection.append(vboxDetailsTable);

}

//Display details data table for VM
//////////////////////////////////
function __vboxDisplayDetailsData(data, multiSelect, targetdiv) {
	
	// No data? Should never happen
	if(typeof data == 'undefined') return;
	
	
	// Accessibility check
	if(data.state == 'Inaccessible') {

		
		var reasonDiv = $('<div />').html('<div style="width: 50%">'+trans('The selected virtual machine is <i>inaccessible</i>. Please inspect the error message shown below and press the <b>Refresh</b> button if you want to repeat the accessibility check:','UIDetailsPagePrivate')+'</div>');
		
		// Details Table
		$('<table />').attr({'style':'width: 50%','class':'vboxDetailsTable vboxDetailsTableError'}).append(__vboxDetailRow(trans("VirtualBox - Error",'UIMessageCenter'), data.accessError['text'])).append(__vboxDetailRow(trans('Result Code: ','UIMessageCenter'), data.accessError['resultCode'])).append(__vboxDetailRow(trans("Component: ",'UIMessageCenter'), data.accessError['component'])).appendTo(targetdiv);
		
		var d = $('<div />').attr({'style':'width: 50%; padding: 4px;'});
		
		$('<input />').attr({'type':'button',
			'value':trans('Refresh','VBoxSelectorWnd'),
			'style':'background: url(images/vbox/refresh_16px.png) 2px 2px no-repeat; padding: 2px 2px 2px 18px; border: 1px solid #000; background-color: #eee;'
		}).click(function(){
			var l = new vboxLoader();
			l.add('machineGetDetails',function(rd){
				$('#vboxIndex').trigger('vmselect',[rd]);
			},{'vm':data.id,'force_refresh':1});
			l.run();
		}).appendTo(d);

		$(reasonDiv).append(d).appendTo(targetdiv);
		
		return;
	}


	// Multi-select details table sections
	////////////////////////////////////////
	$('<table />').attr({'id':'vboxDetailsGeneralTable-'+data.id,'class':'vboxInvisible','style':'width: 100%;'}).append(

		$('<tr />').attr({'style':'vertical-align: top'}).append(

			$('<td />').css({'width':'100%'})
				.append(__vboxCreateDetailsSection(data,'general'))
				.append(__vboxCreateDetailsSection(data,'system'))
		
		).append(
				
			$('<td />')
				.append(__vboxCreateDetailsSection(data,'preview'))
		)
		
	).appendTo(targetdiv);

	for(var s in {'general':1,'system':1,'preview':1}) {
		if(vboxVMDetailsSections[s].onRender)
			vboxVMDetailsSections[s].onRender(data);
	}

	
	// Other sections
	///////////////////////////
	
	// Not shown if multiple vms are selected
	if(multiSelect) return;
	
	for(var s in vboxVMDetailsSections) {
		
		if(vboxVMDetailsSections[s].multiSelectDetailsTable) continue;
		
		if(vboxVMDetailsSections[s].condition && !vboxVMDetailsSections[s].condition(data))
			continue;
		
		$(targetdiv).append(__vboxCreateDetailsSection(data, s));
		
		if(vboxVMDetailsSections[s].onRender)
			vboxVMDetailsSections[s].onRender(data);
		
	}
	
}

//Display details data for VirtualBox Host
/////////////////////////////////////////////
function __vboxDisplayHostDetailsData(data, targetdiv) {
	
	for(var s in vboxHostDetailsSections) {
		
		if(vboxHostDetailsSections[s].condition && !vboxHostDetailsSections[s].condition(data))
			continue;
		
		$(targetdiv).append(__vboxCreateDetailsSection(data, s, vboxHostDetailsSections[s]));
		
		if(vboxHostDetailsSections[s].onRender)
			vboxHostDetailsSections[s].onRender(data);
		
	}
	
}


/*
 *
 * Show / Hide boxes menu
 *
 */
var ul = $('<ul />')
	.attr({'class':'contextMenu contextMenuNoBG','style':'display: none','id':'vboxDetailsShowMenu'})
	.bind('contextmenu', function() { return false; });
	
for(var i in vboxVMDetailsSections) {

	if(typeof(i) != 'string') continue;
	
	// Skip if we shouldn't display
	if(vboxVMDetailsSections[i].condition && !vboxVMDetailsSections[i].condition())
		continue;
	
	$('<li />').attr('id','vboxDetailsShowMenuItem'+i).append(
		
		$('<label />').append(
			
			$('<input />')
				.attr({'type':'checkbox','class':'vboxCheckbox','name':i})
				.prop('checked',$('#vboxIndex').data('vboxCookies')["vboxSectionShow"+i] != 0)
				.click(function(){

					vboxSetCookie("vboxSectionShow"+$(this).attr('name'),(this.checked ? 1 : 0));
					$('#vboxTabVMDetails .vboxVMDetailsBox'+$(this).attr('name')).css('display',(this.checked ? '' : 'none'));

					// Run section's onShow function
					if(this.checked && vboxVMDetailsSections[i].onShow) {
						vboxVMDetailsSections[i].onShow();
					} else if(!this.checked && vboxVMDetailsSections[i].onHide) {
						vboxVMDetailsSections[i].onHide();
					}
		
				})
				
			).append(
				$('<span />').html(vboxVMDetailsSections[i].title)
				
			).disableSelection()
			
		).appendTo(ul);


}
$('#vboxTabVMDetails').append(ul);


/* Menu functionality */
$("#vboxVMDetails").mouseup( function(e) {

	$('ul.contextMenu').hide();
	
	if(e.button == 2) {

		var menu = $('#vboxDetailsShowMenu');
		vboxPositionEvent(menu, e);
		$(menu).show();
		
		e.preventDefault();
		e.stopPropagation();
		
		return false;
	}
	

}).bind('contextmenu', function() { return false; })
	.bind('click',function(e){return e.button!=2;});

</script>
</div>