<!-- 

	VM Details Pane
	Copyright (C) 2010-2012 Ian Moore (imoore76 at yahoo dot com)
	
	$Id$

 -->
<div id='vboxTabVMDetails' style='height: 100%; width: 100%; display: none;' class='vboxInvisible'>

	<!-- VM Details -->
	<div id='vboxVMDetails' style='height: 100%; width: 100%; display: table; min-height:100px;' class='vboxInvisible' />
	
	<!-- Loading... -->
	<div id='vboxDetailsLoading' class='vboxInvisible' style='#position:absolute;#top:50%;display:none;vertical-align:middle;width:100%;height:100%;padding:0px;margin:0px'>
		<div style='#position:relative;#top:-50%;padding:4px;text-align:center;width:100%'>
			<span class='ui-corner-all translate' style='padding:8px;background:#fff;border:2px solid #ddd'>Loading ...</span>
		</div>
	</div>
	
	<!-- Welcome -->
	<div id='vboxDetailsWelcome' class='vboxBordered' style='#position:absolute;#top:50%;display:table-cell;vertical-align:middle;width:50%;height:50%;text-align:center'>
		<div style='#position:relative;#top:-50%;padding:0px;text-align:center;width:100%'>
			<img src='images/vbox/welcome.png' />
		</div>
	</div>
	
<script type='text/javascript'>


// Translate loading div
$('#vboxDetailsLoading').find('span.translate').html(trans('Loading ...','UIVMDesktop')).removeClass('translate');


// Listen for events
/////////////////////////////
$('#vboxPane').bind('vmSelectionListChanged',function(){

	// No VMs?
	if(!vboxChooser || vboxChooser.selectionMode == vboxSelectionModeNone) {
		
		// Hide all tab children first
		$('#vboxTabVMDetails').css({'display':'table','width':'100%'}).children().hide();
		
		// Display Welcome div
		$('#vboxDetailsWelcome').show().css('display','table-cell');
		
		$('#vboxTabVMDetails').data('showingWelcome', true);
		
		return;

	// Were we showing the welcome screen before?
	} else if($('#vboxTabVMDetails').data('showingWelcome')) {
		
		$('#vboxTabVMDetails').css({'display':''})
			.data({'showingWelcome':false}).children().hide();
		$('#vboxVMDetails').html('').css({'display':''});
		
	}
	
	// We have VMs to load
	if(vboxChooser.selectionMode != vboxSelectionModeNone) {

		var targetDiv = $('#vboxVMDetails');
		
		targetDiv.children().empty().remove();

		// Loading scren
		if(vboxChooser.selectedVMs.length == 1 && $('#vboxTabVMDetails').css('display') != 'none') {
				
			// Hide all tab children first
			$('#vboxTabVMDetails').css({'display':'table','width':'100%'}).children().hide();
				
			// Display loading div
			$('#vboxDetailsLoading').show().css('display','table-cell');
		}
		
		if(vboxChooser.getSingleSelectedId() == 'host') {

			$.when(vboxVMDataMediator.getVMDetails('host')).then(function(d) {
				
				targetDiv.siblings().hide();
				targetDiv.show();
				
				// Clear target div if we only have one vm
				if(vboxChooser.selectedVMs.length == 1) {
					targetDiv.children().empty().remove();					
				}

				__vboxDisplayHostDetailsData(d, targetDiv);

			});

			return;
		}
		

		// Placeholders so vms are listed in order			
		for(var i = 0; i < vboxChooser.selectedVMs.length; i++) {
			$('<table />').attr({'id':'vboxDetailsGeneralTable-'+vboxChooser.selectedVMs[i],'class':'vboxInvisible vboxVMDetailsBox-vm-'+vboxChooser.selectedVMs[i],'style':'display:none'})
				.appendTo(targetDiv);
		}
		
		
		// Get data and draw
		for(var i = 0; i < vboxChooser.selectedVMs.length; i++) {
			
			$.when(vboxVMDataMediator.getVMDataCombined(vboxChooser.selectedVMs[i])).then(function(d) {
				
				
				// Clear target div if we only have one vm
				if(vboxChooser.selectedVMs.length == 1) {
					targetDiv.siblings().hide();
					targetDiv.show();		
				}

				__vboxDisplayDetailsData(d, (vboxChooser.selectedVMs.length > 1), targetDiv);
			
			});
		}
		

	}

// VM data has been changed
/////////////////////////////
}).bind('vboxMachineDataChanged',function(e, vmid) {
	
	// Nothing to do if VM is not selected
	if(!vboxChooser.isVMSelected(vmid)) return;
	
	// Target for actions
	var targetDiv = $('#vboxVMDetails');

	// Get and show details and runtime data again	
	$.when(vboxVMDataMediator.getVMDataCombined(vmid)).then(function(d) {
		// if there's only one, we'll have to remove existing data
		if(vboxChooser.selectedVMs.length == 1) {
			targetDiv.children().empty().remove();
		}
		__vboxDisplayDetailsData(d, (vboxChooser.selectedVMs.length > 1), targetDiv);
	});
	

		
// Machine state changes
/////////////////////
}).bind('vboxMachineStateChanged', function(e, vmid, state) {
	
	// Not a selected VM, nothing to do
	if(!vboxChooser.isVMSelected(vmid)) return;
	
	// Redraw all sections that ask for a redraw on state changes
	$.when(vboxVMDataMediator.getVMDataCombined(vmid)).then(function(vmData) {

			
			var multiSelect = (vboxChooser.selectedVMs.length > 1);
			
			// Each section
			for(var i in vboxVMDetailsSections) {
				
				if(typeof(i) != 'string') continue;
				
				// Skip if this section isn't shown
				if(multiSelect && !vboxVMDetailsSections[i].multiSelectDetailsTable)
					continue;
				
				// Redraw section
				if(vboxVMDetailsSections[i].redrawOnStateChange) {
					
					$('#vboxDetailsSectionId-'+i+'-'+vmData.id).replaceWith(
						__vboxCreateDetailsSection(vmData, i)
					);
						
					if(vboxVMDetailsSections[i].onRender)
						vboxVMDetailsSections[i].onRender(vmData);
					
				// Just run onRender?
				} else if(vboxVMDetailsSections[i].rerenderOnStateChange) {
					vboxVMDetailsSections[i].onRender(vmData);
				}
				
				
					
			}
		});
		

	
	
});

/*
 * Redraw events specified in details sections
 */
for(var i in vboxVMDetailsSections) {
	
	if(typeof(i) != 'string') continue;
	
	if(vboxVMDetailsSections[i].redrawMachineEvents) {
		
		for(var a = 0; a < vboxVMDetailsSections[i].redrawMachineEvents.length; a++) {
			
			// Assume that the first argument for machine related events is the VM id
			$('#vboxPane').on(vboxVMDetailsSections[i].redrawMachineEvents[a], {'sectionName':i}, function(e, vmid, xtra) {
	
				// VM is not selected. Ignore.
				if(!vboxChooser.isVMSelected(vmid)) return;
				
				var sectionName = e.data.sectionName;

				// Skip if it doesn't exist
				if(!$('#vboxDetailsSectionId-'+sectionName+'-'+vmid)[0]) return;


				// Load data and redraw section
				$.when(vboxVMDataMediator.getVMDataCombined(vmid)).then(function(d) {
					
					$('#vboxDetailsSectionId-'+sectionName+'-'+d.id).replaceWith(
						__vboxCreateDetailsSection(d, sectionName)
					);
					
					if(vboxVMDetailsSections[sectionName].onRender)
						vboxVMDetailsSections[sectionName].onRender(d);
					
				});
				
			});
		}
	}
}

// Hide context menus when hiding tab
$('#vboxTabVMDetails').bind('hide',function(){
	$('ul.contextMenu').hide();
});



//Base function that returns a table row of machine detail data
//Called from other functions
function __vboxDetailRow(name,value,cssClass,html) {
	
	// convert to strings
	if(typeof(value) == 'undefined') value = '';
	name = ''+name;
	value = ''+value;
	
	
	var tr = $('<tr />').attr({'class':'vboxDetailRow'});
	$('<th />').html(name + (value && value.length && name.length ? ':' : ''))
		.attr({'class':'vboxDetailContent ' + cssClass})
		.appendTo(tr);
	
	$('<td />').attr({'class':'vboxDetailsValue'}).html(value).appendTo(tr);

	return tr;
}

//Draw rows to table
function __vboxDetailAddRows(data, rows, table) {
	
	// Is rows a function?
	if(typeof(rows) == 'function') rows = rows(data);

	for(var i = 0; i < rows.length; i++) {
		
		// Check if row has condition
		if(rows[i].condition && !rows[i].condition(data)) continue;
		
		// hold row data
		var rowData = '';
		
		// Check for row attribute
		if(rows[i].attrib) {
			if(!data[rows[i].attrib]) continue;
			rowData = data[rows[i].attrib];
		
		// Check for row callback
		} else if(rows[i].callback) {
			rowData = rows[i].callback(data);

		// Static data
		} else {
			rowData = rows[i].data;
		}

		if(rows[i].rawRow) {
			$(table).append(rowData);
		} else {
			$(table).append(__vboxDetailRow(rows[i].title, rowData, 'vboxDetailName' + (rows[i].indented ? 'Indent' : ''), rows[i].html));
		}
		
	}
	
}

// Details section
////////////////////////////
function __vboxCreateDetailsSection(data, sectionName, section) {
	
	if(!section)
		section = vboxVMDetailsSections[sectionName];

	var ttemplate = "<img style='float:left;  margin-right: 3px;' src='images/vbox/%1' class='vboxDetailsSectionIcon'/><span style='float:left'>"+
	"<a href=\"javascript:vboxVMsettingsInit('"+data.id+"',null,'%2');\">%3</a>"+
	"</span><span class='vboxDetailsUpDnImgSpan' style='float:right' onClick='$(this).parent().trigger(\"dblclick\");' />";
	
	// No link if VM is not in valid state
	if(!((vboxVMStates.isRunning(data) || vboxVMStates.isEditable(data)) && !vboxVMStates.isSaved(data))) {
		ttemplate = "<img style='float:left;  margin-right: 3px;' src='images/vbox/%1' class='vboxDetailsSectionIcon'/><span style='float:left'>%3</span><span class='vboxDetailsUpDnImgSpan' style='float:right' onClick='$(this).parent().trigger(\"dblclick\");' />";
	}

	var vboxDetailsTable = $('<table />')
		.attr({'class':'vboxDetailsTable vboxDetailsTableBox'})
		.append($('<thead />')
			.append($('<tr />').attr({'class':'vboxDetailsHead'})
				.append($('<th />').attr({'class':'vboxDetailsSection','colspan':'2'})
					.append($('<div />')
						.addClass(!((vboxVMStates.isEditable(data) || vboxVMStates.isRunning(data)) && !vboxVMStates.isSaved(data)) ? 'vboxNoLinks' : '')
						.html(ttemplate.replace('%1',section.icon).replace('%2', section.settingsLink).replace('%3', section.title))
					)
				).disableSelection()
			)
		);

	
	var tbody = $('<tbody />');
	
	__vboxDetailAddRows(data, section.rows, tbody);
	
	
	// Class added to last row to aid in rounded corners
	if(section.noFooter) {
		tbody.children().last().addClass('vboxTableLastRow');
	} else {
		tbody.append($('<tr />').addClass('vboxTableLastRow').append($('</td >')).append('<td />'));
	}
	
	vboxDetailsTable.append(tbody);

	var vboxDetailsSection = $('<div />')
		.attr({'class':'vboxDetailsBorder vboxVMDetailsBox'+sectionName+ ' vboxVMDetailsBox-vm-'+data.id,'id':'vboxDetailsSectionId-'+sectionName+'-'+data.id})
		.dblclick(function(e){

			vboxSetCookie('vboxSectionCollapse'+$(this).data('sectionName'),
					($(this).hasClass('vboxDetailsSectionCollapsed') ? '' : '1')
			);
			
			$('#vboxVMDetails').find('div.vboxVMDetailsBox'+$(this).data('sectionName'))
				.toggleClass('vboxDetailsSectionCollapsed', 500);

			return false;
		}).hover(function(){$(this).addClass('hover');},
			function(){$(this).removeClass('hover');}
		).disableSelection().data({'sectionName':sectionName});

	if($('#vboxPane').data('vboxCookies')["vboxSectionCollapse"+sectionName]) {
		vboxDetailsSection.addClass('vboxDetailsSectionCollapsed');
	}
	
	if($('#vboxPane').data('vboxCookies')["vboxSectionShow"+sectionName] == 0) {
		$(vboxDetailsSection).hide();
	} else {
		$(vboxDetailsSection).show();
	}

	/* Context menu for section ? */
	if(section.contextMenu) {
		
		var menu = section.contextMenu();
				
		$(vboxDetailsSection).mouseup( function(e) {

			$('ul.contextMenu').hide();
			
			if(e.button == 2) {

				$(menu).trigger('beforeshow', data);
				
				vboxPositionEvent(menu, e);
				$(menu).show();
				
				e.preventDefault();
				e.stopPropagation();
				
				return false;
			}
			
		});
		
		$(vboxDetailsSection)
			.bind('contextmenu', function() { return false; })
			.bind('click',function(e){return e.button!=2;});

	}
	return vboxDetailsSection.append(vboxDetailsTable);

}

//Display details data table for VM
//////////////////////////////////
function __vboxDisplayDetailsData(data, multiSelect, targetDiv) {
	
	// No data? Should never happen
	if(typeof data == 'undefined') return;
	
	
	// Accessibility check
	if(data.state == 'Inaccessible') {

		
		var reasonDiv = $('<div />').html('<div style="width: 50%">'+trans('The selected virtual machine is <i>inaccessible</i>. Please inspect the error message shown below and press the <b>Refresh</b> button if you want to repeat the accessibility check:','UIDetailsPagePrivate')+'</div>');
		
		// Details Table
		$('<table />').attr({'style':'width: 50%','class':'vboxDetailsTable vboxDetailsTableError vboxVMDetailsBox-vm-'+data.id}).append(__vboxDetailRow(trans("VirtualBox - Error",'UIMessageCenter'), data.accessError['text'])).append(__vboxDetailRow(trans('Result Code: ','UIMessageCenter'), data.accessError['resultCode'])).append(__vboxDetailRow(trans("Component: ",'UIMessageCenter'), data.accessError['component'])).appendTo(targetDiv);
		
		var d = $('<div />').attr({'style':'width: 50%; padding: 4px;'});
		
		$('<input />').attr({'type':'button',
			'value':trans('Refresh','UIVMLogViewer'),
			'style':'background: url(images/vbox/refresh_16px.png) 2px 2px no-repeat; padding: 2px 2px 2px 18px; border: 1px solid #000; background-color: #eee;'
		}).click(function(){
			var l = new vboxLoader();
			l.add('machineGetDetails',function(rd){
				$('#vboxPane').trigger('vmSelectionListChanged');
			},{'vm':data.id});
			l.run();
		}).appendTo(d);

		$(reasonDiv).append(d).appendTo(targetDiv);
		
		return;
	}

	// Multi-select details table sections
	////////////////////////////////////////
	var tbl = $('<table />').attr({'id':'vboxDetailsGeneralTable-'+data.id,'class':'vboxInvisible vboxVMDetailsBox-vm-'+data.id,'style':'width: 100%;'}).append(

		$('<tr />').attr({'style':'vertical-align: top'}).append(

			$('<td />').css({'width':'100%'})
				.append(__vboxCreateDetailsSection(data,'general'))
				.append(__vboxCreateDetailsSection(data,'system'))
		
		).append(
				
			$('<td />')
				.append(__vboxCreateDetailsSection(data,'preview'))
		)
		
	).data({'vmid':data.id});
	
	// If already exists, replace the table, else append to div
	if($('#vboxDetailsGeneralTable-'+data.id)[0]) {
		$('#vboxDetailsGeneralTable-'+data.id).replaceWith(tbl);
	} else {
		tbl.appendTo(targetDiv);
	}
	
	for(var s in {'general':1,'system':1,'preview':1}) {
		if(vboxVMDetailsSections[s].onRender)
			vboxVMDetailsSections[s].onRender(data);
	}

	
	// Other sections
	///////////////////////////
	
	// Not shown if multiple vms are selected
	if(multiSelect) return;
	
	for(var s in vboxVMDetailsSections) {
		
		if(vboxVMDetailsSections[s].multiSelectDetailsTable) continue;
		
		if(vboxVMDetailsSections[s].condition && !vboxVMDetailsSections[s].condition(data))
			continue;
		
		$(targetDiv).append(__vboxCreateDetailsSection(data, s));
		
		if(vboxVMDetailsSections[s].onRender)
			vboxVMDetailsSections[s].onRender(data);
		
		
	}
	
}

//Display details data for VirtualBox Host
/////////////////////////////////////////////
function __vboxDisplayHostDetailsData(data, targetDiv) {
	
	for(var s in vboxHostDetailsSections) {
		
		if(vboxHostDetailsSections[s].condition && !vboxHostDetailsSections[s].condition(data))
			continue;
		
		$(targetDiv).append(__vboxCreateDetailsSection(data, s, vboxHostDetailsSections[s]));
		
		if(vboxHostDetailsSections[s].onRender)
			vboxHostDetailsSections[s].onRender(data);
		
	}
	
}


/*
 *
 * Show / Hide boxes menu
 *
 */
var ul = $('<ul />')
	.attr({'class':'contextMenu contextMenuNoBG','style':'display: none','id':'vboxDetailsShowMenu'})
	.bind('contextmenu', function() { return false; });
	
for(var i in vboxVMDetailsSections) {

	if(typeof(i) != 'string') continue;
	
	// Skip if we shouldn't display
	if(vboxVMDetailsSections[i].condition && !vboxVMDetailsSections[i].condition())
		continue;
	
	$('<li />').attr('id','vboxDetailsShowMenuItem'+i).append(
		
		$('<label />').append(
			
			$('<input />')
				.attr({'type':'checkbox','class':'vboxCheckbox','name':i})
				.prop('checked',$('#vboxPane').data('vboxCookies')["vboxSectionShow"+i] != 0)
				.on('click',{'sectionName':i},function(e){

					vboxSetCookie("vboxSectionShow"+$(this).attr('name'),(this.checked ? 1 : 0));
					$('#vboxTabVMDetails .vboxVMDetailsBox'+$(this).attr('name')).css('display',(this.checked ? '' : 'none'));

					var sectionName = e.data.sectionName;
					
					// Run section's onShow function
					if(this.checked && vboxVMDetailsSections[sectionName].onShow) {
						vboxVMDetailsSections[sectionName].onShow();
					} else if(!this.checked && vboxVMDetailsSections[sectionName].onHide) {
						vboxVMDetailsSections[sectionName].onHide();
					}
		
				})
				
			).append(
				$('<span />').html(vboxVMDetailsSections[i].title)
				
			).disableSelection()
			
		).appendTo(ul);


}
$('#vboxTabVMDetails').append(ul);


/* Menu functionality */
$("#vboxVMDetails").mouseup( function(e) {

	$('ul.contextMenu').hide();
	
	if(e.button == 2) {

		var menu = $('#vboxDetailsShowMenu');
		vboxPositionEvent(menu, e);
		$(menu).show();
		
		e.preventDefault();
		e.stopPropagation();
		
		return false;
	}
	

}).bind('contextmenu', function() { return false; })
	.bind('click',function(e){return e.button!=2;});

//Display Welcome div
$('#vboxTabVMDetails').css({'display':'table','width':'100%'}).children().hide();
$('#vboxDetailsWelcome').show().css('display','table-cell');
$('#vboxTabVMDetails').data('showingWelcome', true);

</script>
</div>