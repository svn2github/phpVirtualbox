<!-- 

	Virtual Machine List
	Copyright (C) 2010-2012 Ian Moore (imoore76 at yahoo dot com)
	
	$Id$

 -->
<div id='vboxVMList'>
	<div id='vboxVMListSpinner' style='text-align: center'>
		<img src='images/spinner.gif' alt="" />
	</div>
</div>
<script type='text/javascript'>


/*
 * 
 *
 * Startup for VM List and Toolbar
 *
 */

// Create VM list
var vboxVMList = new vboxVMList('vboxVMList');
vboxVMList.interval = ($('#vboxIndex').data('vboxConfig').listUpdateInterval ? $('#vboxIndex').data('vboxConfig').listUpdateInterval : 5);
// Failsafe
if(isNaN(vboxVMList.interval)) vboxVMList.interval = 5;

// VM List Context menu for each VM
var sChildren = [];
for(var i = 0; i < vboxVMActions.stop_actions.length; i++) {
	sChildren[sChildren.length] = $.extend({},vboxVMActions[vboxVMActions.stop_actions[i]],{'name':vboxVMActions.stop_actions[i],'iconStringDisabled':'_disabled','context':(vboxVMActions[vboxVMActions.stop_actions[i]].context ? vboxVMActions[vboxVMActions.stop_actions[i]].context : 'UIActionPool')});
}

/*
 * VM Context menu setup (menu per VM in list)
 */
vboxVMList.vmContextMenuItems = [
	$.extend({},vboxVMActions['settings'],{'name':'settings'}),
	$.extend({},vboxVMActions['clone'],{'name':'clone'}),
	$.extend({},vboxVMActions['remove'],{'name':'remove'}),
	$.extend({},vboxVMActions['start'],{'name':'start','separator' : true}),
	$.extend({},vboxVMActions['stop'],{'name':'stop','icon':'state_powered_off','children':sChildren,'hide_on_disabled':true}),
	$.extend({},vboxVMActions['discard'],{'name':'discard'}),
	$.extend({},vboxVMActions['refresh'],{'name':'refresh','separator' : true}),
	$.extend({},vboxVMActions['logs'],{'name':'logs'})
];

/*
 * VM list context menu setup
 */
vboxVMList.parentContextMenuItems = [
	$.extend({},vboxVMActions['new'],{'name':'new'}),
	$.extend({},vboxVMActions['add'],{'name':'add'}),
	{
		'name':'fileImport',
		'label':'Import Appliance...',
		'icon':'import',
		'click':function(){vboxWizardImportApplianceInit();},
		'separator': true
	},
	{
		'name':'fileExport',
		'label':'Export Appliance...',
		'icon':'export',
		'click':function(){vboxWizardExportApplianceInit();}
	}                                     
];


// Initial action update
$('#vboxIndex').trigger('chooserSelectionChanged', [[]]);

vboxVMList.run();


/*
 * Virtual Machine list object.
 * 
 * This may seem a bit odd: "self.FOO" instead of "this.FOO" used
 * to get around JavaScript limitation. When a method is called
 * as a result of an ajax request returning, "this" refers to the
 * JavaScript window object rather than the originating object.
 * Creating and using a class local "self" variable that refers
 * to the object gets around this limitation.
 */

function vboxVMList(anchorid) {

	var self = this;
	this.vms = null;
	this.anchorid = anchorid;
	this.sortDefault = function(a,b){return strnatcasecmp(a.name,b.name);};
	this.selectedList = [];
	this._sortOrder = {};
	this._updateSortOrder = false;
	this.lastUpdatedDiv = null;
	this.anchor = $('#'+anchorid);
	this.interval = 5;
	this.changed = false;
	this.versionChecked = false;
	this.vmContextMenuItems = [];
	this.parentContextMenuItems = [];
	this.contextMenuObj = null;
	this.enforceVMOwnership = $('#vboxIndex').data('vboxConfig').enforceVMOwnership;
	this.tip = trans('<nobr>%1<br></nobr><nobr>%2 since %3</nobr><br><nobr>Session %4</nobr>','UIVMListView');
	

	this.sort = function(a,b) {
		
		// Check for host
		if(a.id == 'host') return -1;
		if(b.id == 'host') return 1;
		
		//A is not in sort list
		if(typeof(self._sortOrder[a.id]) == 'undefined') {
			if(typeof(self._sortOrder[b.id]) == 'undefined') return self.sortDefault(a,b);
			return -1; // b is defined, a is not
		}
		if(typeof(self._sortOrder[b.id]) == 'undefined') return 1; // a is defined, b is not
		if(parseInt(self._sortOrder[a.id]) == parseInt(self._sortOrder[b.id])) return 0;
		return(parseInt(self._sortOrder[a.id]) < parseInt(self._sortOrder[b.id]) ? -1 : 1);
		
	};
	
	// If there are multiple servers configured, setup menu
	if($('#vboxIndex').data('vboxConfig').servers.length) {

		var servers = $('#vboxIndex').data('vboxConfig').servers;
		var ul = $('<ul />').attr({'id':'vboxServerMenu','style':'display: none','class':'contextMenu'});
		for(var i = 0; i < servers.length; i++) {
			$('<li />').html("<a href='#" + $('<div />').html(servers[i].name).text() + "' style='background-image: url(images/vbox/OSE/VirtualBox_16px.png);'>"+$('<div />').html(servers[i].name).text()+"</a>").appendTo(ul);
		}
		$('#vboxIndex').append(ul);
		
	}
	
	// Update list of VMs
	/////////////////////////
	self.updateList = function(d) {

		// We were stopped before the request returned data
		if(!self._running) return;
		
		
		if(!d || !d.vmlist) {
			
			vboxAlert(trans('There was an error obtaining the list of registered virtual machines from VirtualBox. Make sure vboxwebsrv is running and that the settings in config.php are correct.<p>The list of virtual machines will not begin auto-refreshing again until this page is reloaded.</p>','phpVirtualBox'));
			
			self.stop();
			self.anchor.children().remove();
			return;
		}

		var currTime = new Date();
		self.time = currTime.getTime();

		/* Check Key
			If we've changed hosts before the last ajax call to get a list of VMs
			returns, we'd have a list of VMs from the previously selected VirtualBox
			host.
		*/
		if(d.server_key != $('#vboxIndex').data('vboxConfig').key) return;
		
		currVMList = d.vmlist;
		

		// First time run?
		if(self.vms === null) {
			
			// Remove spinner
			self.anchor.children().remove();
			
			// reset selfvms
			self.vms = {};
			
			// Draw host placeholder
			self.anchor.append($('<table />').addClass('vboxVMListItem-'+self.anchorid+'-host'));
			
			// Draw groups
			self.anchor.append(self.groupHTML($('#vboxIndex').data('vboxVMGroups'), true));
			
		}

		// Add host
		currVMList[currVMList.length] = {
			'id':'host',
			'state':'Hosting',
			'owner':'',
			'name':$('#vboxIndex').data('vboxConfig').name,
			'OSTypeId':'VirtualBox_Host',
			lastUpdated:self.time
		};
		
		
		// Enforce VM ownership
        if(self.enforceVMOwnership && !$('#vboxIndex').data('vboxSession').admin) {
        	currVMList = jQuery.grep(currVMList,function(vm,i){
        		return (vm.owner == $('#vboxIndex').data('vboxSession').user);
        	});
		}
	
		// Each item in list
		var changed = false;
		for(var i = 0; i < currVMList.length; i++) {	
			
			// Update
			changed = self.updateVM(currVMList[i]);

			// Does not exist, add to list
			if(!self.vms[currVMList[i].id]) {
				
				self.vms[currVMList[i].id] = currVMList[i];
				
				changed = true;
			}

			self.vms[currVMList[i].id].lastUpdated = self.time;
			
		}

		// Check for any vms that should be removed
		for(var id in self.vms) {
			if(self.vms[id].lastUpdated != self.time) {
				self.machineRemove(id);
				changed = true;
			}
		}
		
		// Update "Last Updated" ?
		if(self.lastUpdatedDiv) {
			var hours = currTime.getHours();
			var minutes = currTime.getMinutes();
			var secs = currTime.getSeconds();
			if (minutes < 10) minutes = "0" + minutes;
			if (secs < 10) secs = "0" + secs;
			
			$(self.lastUpdatedDiv).html(hours+':'+minutes+':'+secs);
		}
		
		if(changed && !self.changed) {
			vboxNotifyBrowser(1);
		} else if(self.changed && !changed) {
			vboxNotifyBrowser();
		}
		
		self.changed = changed;
		
	};
	

	// Update a VM in our list
	self.updateVM = function(vmUpdate,index) {

		var changed = false;
		var changedProps = ['currentSnapshotName','state','sessionState','OSTypeId','name','customIcon','groups'];
		
		if(!self.vms[vmUpdate.id]) {
			changed = true;
		} else {
			for(var i = 0; i < changedProps.length; i++) {
				if(String(self.vms[vmUpdate.id][changedProps[i]]) != String(vmUpdate[changedProps[i]])) {
					changed = true;
					break;
				}
			}
		}		

		if(changed) {

			$('#'+self.anchorid).find('table.vboxVMListItem-'+self.anchorid+'-'+vmUpdate.id).each(function(i,elm){
				
				var newHTML = self.vmHTML(vmUpdate);
				if($(elm).hasClass('vboxListItemSelected'))
					$(newHTML).addClass('vboxListItemSelected').removeClass('vboxHover');
				$(elm).replaceWith(newHTML);
			});
			self.vms[vmUpdate.id] = vmUpdate;
				
			$('#vboxIndex').trigger('vmChanged', [vmUpdate]);
		}
		

		return changed;

	};

	self.vmHTML = function (vmn) {
		
		var tbl = $('<table />').attr({'class':'vboxVMListItem-'+self.anchorid+'-'+vmn.id + " vboxVMListVM"}).bind('click',self.selectItem).hover(function(){
			if(!$(this).hasClass('vboxListItemSelected'))
				$(this).addClass('vboxHover');
			},function(){$(this).removeClass('vboxHover');}).data('vmid',vmn.id);
		
		if(vmn.id != 'host') {
			$(tbl).draggable({'cursorAt':{left: -10, top: -10},'helper':function(){
				
				return $(this).clone().css({'width':'auto','display':'inline','background':'#fff','border-color':'#69f'}).removeClass('vboxHover');
			},'start':function() {
				
				self._dragging = vmn.id;
				$(self.anchor).find('table.vboxHover').removeClass('vboxHover');
				
			},'stop':function(e) {

				self._dragging = null;
				
				// Where was this dropped?
				var dropTarget = $('#'+self.anchorid).find('td.vboxVMListDropTargetHover');
				
				// Dropped above / below a VM
				if(dropTarget[0]) {
					
					// Dropped from another group into this one,
					// but this group already has this VM
					if((dropTarget.closest('table').parent().siblings('div.vboxVMListGroupHeader').data('vmGroupPath') != $(this).parent().siblings('div.vboxVMListGroupHeader').data('vmGroupPath')) 
							&& dropTarget.closest('table').siblings('table.vboxVMListItem-'+self.anchorid+'-'+$(this).data('vmid'))[0])
							return true;
										
					// Get VM from target's parent table
					if(dropTarget.hasClass('vboxDropTargetTop')) {
						$(this).detach().insertBefore($(dropTarget).closest('table'));
					} else {
						$(this).detach().insertAfter($(dropTarget).closest('table'));
					}
				
				// Not dropped above / below vm
				} else {
					
					// Dropped ON a vm?
					dropTarget = $('#'+self.anchorid).find('table.vboxHover').first();
					if($(dropTarget).data('vmid')) {
					
						// Create a group?
						dropTarget = $('#'+self.anchorid).find('table.vboxHover').first();
						
						// Nothing to do. Not dropped on valid target
						if(!dropTarget[0] || ($(dropTarget).data('vmid') == $(this).data('vmid'))) return true;
						
											
						
						// Where to drop this..
						var p = dropTarget.closest('div.vboxVMListGroup').children('div.vboxVMListGroupVMs');
						// assume root?
						if(!p[0]) p = self.anchor.children('div.vboxVMListGroupVMs');

						// Determine group name
						var gname = trans('New group','UIGChooserModel');
						var tgname = gname;
						
						for(var i = 1; i < 100; i++) {
							tgname = gname + (i == 1 ? '' : ' ' + i);
							if(!$(p).siblings().children('div.vboxVMListGroupHeader').children('span.vboxVMListGroupName[title="' + tgname + '"]')[0])
								break;
						}
					
						// Create group definition
						var gdef = {
							name: tgname,
							subgroups: [],
							machines: [dropTarget.data('vmid'), $(this).data('vmid')]
						};
						
						
						// New position is below target
						var ghtml = self.groupHTML(gdef);
						
						ghtml.find('table.vboxVMListItem-'+self.anchorid+'-'+$(this).data('vmid')).replaceWith($(this).detach());
						ghtml.find('table.vboxVMListItem-'+self.anchorid+'-'+dropTarget.data('vmid')).replaceWith(dropTarget.detach());
						
						ghtml.insertBefore(p);
					
					// Dropped in the main VM list or group header?
					} else {
						
						dropTarget = $(self.anchor).find('div.vboxHover').first();
						if(dropTarget[0] && dropTarget.hasClass('vboxVMListGroupHeader')) {
							
							// Group already has this VM?
							if(dropTarget.siblings('div.vboxVMListGroupVMs').children('table.vboxVMListItem-'+self.anchorid+'-'+$(this).data('vmid'))[0])
								return;
							
							$(this).detach().appendTo(dropTarget.siblings('div.vboxVMListGroupVMs').first());
						
						} else if($(self.anchor).hasClass('vboxVMListDropTargetHover')) {
						
						
							// Already in this list?
							if(self.anchor.children('div.vboxVMListGroup').children('div.vboxVMListGroupVMs').children('table.vboxVMListItem-'+self.anchorid+'-'+$(this).data('vmid'))[0])
								return true;
							
							
							$(this).detach().appendTo(self.anchor.children('div.vboxVMListGroup').children('div.vboxVMListGroupVMs').first());

						}
					}
					
				}

				self.composeGroupDef();
				
			}});
		}

		var td = $('<td />').attr({'colspan':'2'}).addClass('vboxVMListDropTarget vboxDropTargetTop');
		if(vmn.id != 'host') {
			td.hover(function(){
				if(self._dragging && self._dragging != vmn.id)
					$(this).addClass('vboxVMListDropTargetHover');
			},function(){
				$(this).removeClass('vboxVMListDropTargetHover');
			}
			);
		}
		$('<tr />').append(td).appendTo(tbl);

		
		var tr = $('<tr />');

		// VM OS type icon
		if($('#vboxIndex').data('vboxConfig').enableCustomIcons && vmn.customIcon) {
			$('<td />').attr({'rowspan':'2'}).html("<img src='" + vmn.customIcon + "' class='vboxVMIcon' />").appendTo(tr);
		} else {
			$('<td />').attr({'rowspan':'2'}).html("<img src='images/vbox/" + vboxGuestOSTypeIcon(vmn.OSTypeId) + "' class='vboxVMIcon" + (vmn.id == 'host' ? " vboxHostIcon" : "") + "' />").appendTo(tr);
		}
		
		
		// VM Name
		var td = $('<td />').attr({'class':'vboxVMTitle'});
		
		// Host can have HTML in name
		if(vmn.id == 'host') {
			
			// Check for multiple server config
			if($('#vboxIndex').data('vboxConfig').servers.length) {
				var span = $('<span />').attr({'class':'vboxServerLink'}).text('('+$('#vboxIndex').data('vboxConfig').name+')').contextMenu({
						menu: 'vboxServerMenu',
						button: 0,
						mode: 'menu'
					},
					function(a) {
						if(a == $('#vboxIndex').data('vboxConfig').name) return;						
						vboxSetCookie("vboxServer",a);
						$('#vboxIndex').trigger('hostChange',[a]);
					}
				);
				$(td).html('<span class="vboxVMName">VirtualBox</span> ').append(span);
			} else {				
				$(td).html('<span class="vboxVMName">VirtualBox</span> ('+vmn.name+')');
			}
		} else {
			
			$(td).append('<span class="vboxVMName">'+$('<span />').text(vmn.name).html()+'</span>'+ (vmn.currentSnapshotName ? ' (' + $('<span />').text(vmn.currentSnapshotName).html() + ')' : ''));
			
			var sdate = new Date(vmn.lastStateChange * 1000);

			// Table gets tool tips
			tip = self.tip.replace('%1',('<b>'+$('<span />').text(vmn.name).html()+'</b>'+(vmn.currentSnapshotName ? ' (' + $('<span />').text(vmn.currentSnapshotName).html() + ')' : ''))).replace('%2',trans(vboxVMState(vmn.state),'VBoxGlobal')).replace('%3',sdate.toLocaleString()).replace('%4',trans(vmn.sessionState,'VBoxGlobal'));
			$(tbl).tipped({'source':tip,'position':'mouse','delay':2000});
		}
		
		$(tr).append(td).appendTo(tbl);
		
		
		var tr = $('<tr />');
		
		var td = $('<td />').attr({'class':(vmn.id != 'host' && vmn.sessionState != 'Unlocked' ? 'vboxVMSessionOpen' : '')}).html("<img src='images/vbox/" + vboxMachineStateIcon(vmn.state) +"' /> <span class='vboxVMState'>" + trans(vboxVMState(vmn.state),'VBoxGlobal') + '</span>');

		// Add VirtualBox version if hosting
		if(vmn.id == 'host') {
			
			$(td).append(' - ' + $('#vboxIndex').data('vboxConfig').version.string);
			
			// Check for version mismatches?
			if(!self.versionChecked) {
				self.versionChecked = true;
				var vStr = $('#vboxIndex').data('vboxConfig').phpvboxver.substring(0,$('#vboxIndex').data('vboxConfig').phpvboxver.indexOf('-'));
				var vers = $('#vboxIndex').data('vboxConfig').version.string.replace('_OSE','').split('.');
				if(vers[0]+'.'+vers[1] != vStr) {
					vboxAlert('This version of phpVirtualBox ('+$('#vboxIndex').data('vboxConfig').phpvboxver+') is incompatible with VirtualBox ' + $('#vboxIndex').data('vboxConfig').version.string + ". You probably need to <a href='http://code.google.com/p/phpvirtualbox/downloads/list?q=phpvirtualbox-"+vers[0]+'.'+vers[1]+"' target=_blank>download the latest phpVirtualBox " + vers[0]+'.'+vers[1] + "-x</a>.<p>See the Versioning section <a href='http://code.google.com/p/phpvirtualbox/downloads/detail?name=README.txt' target=_blank>here</a> for more information</p>",{'width':'auto'});
				}
			}			
		}
		
		$(tr).append(td).appendTo(tbl);

		// Droppable targets
		var td = $('<td />').attr({'colspan':'2'}).addClass('vboxVMListDropTarget vboxDropTargetBottom');
		if(vmn.id != 'host') {
			td.hover(function(){
				if(self._dragging && self._dragging != vmn.id)
					$(this).addClass('vboxVMListDropTargetHover');
				},function(){
					$(this).removeClass('vboxVMListDropTargetHover');
				}
			);
		}
		$('<tr />').append(td).appendTo(tbl);
		
		// Context menu?
		if(self.contextMenuObj) {
			$(tbl).contextMenu({
				menu: self.contextMenuObj.menuId(),
				menusetup : function(el) {
					if(!$(el).hasClass('vboxListItemSelected')) $(el).trigger('click');
				}
			},self.contextMenuObj.menuClickCallback);
		}
		
		// Open settings on dblclick
		$(tbl).dblclick(function(){
			if(self.vmContextMenuItems[0].enabled(vmn))
				self.vmContextMenuItems[0].click(vmn);
		});
		
		return tbl;
		
	};

	
	/*
	 * Machine removed from list
	 */
	self.machineRemove = function(id) {
		
		var changed = false;
		
		var selectedList = self.selectedList.filter(function(v){
			return (v.type == 'group' || (v.id != id));
		});
		if (self.selectedList.length != selectedList.length)
			changed = true;
		
		self.selectedList = selectedList;
		
		if(changed)
			$('#vboxIndex').trigger('chooserSelectionChanged', [selectedList]);
		
		$('#'+self.anchorid +' table.vboxVMListItem-'+self.anchorid+'-'+id).remove();
		
		$('#vboxIndex').trigger('vmRemoved', [id]);
		
		delete self.vms[id];
	};

	/*
	 * Compose group data from GUI
	 */
	self.composeGroupDef = function(elm, parentPath) {
		
		if(!elm) {
			elm = self.anchor;
			parentPath = '';
		}
		var groupDef = {
			name : $(elm).children('div.vboxVMListGroupHeader').children('span.vboxVMListGroupName').text(),
			subgroups : [],
			machines : []
		};
		groupDef.path = parentPath+'/'+groupDef.name;
		groupDef.path = groupDef.path.replace('//','/');
		
		// Get a list of subgroups
		$(elm).children('div.vboxVMListGroup').each(function(index, selm){
			groupDef.subgroups[groupDef.subgroups.length] = self.composeGroupDef(selm, groupDef.path);
		});
		
		// Get a list of machines
		if($(elm).attr('id') == self.anchorid) {
			$(elm).children('table.vboxVMListVM').each(function(index, selm){
				if($(selm).data('vmid') != 'host')
					groupDef.machines[groupDef.machines.length] = $(selm).data('vmid');
			});			
		} else {
			$(elm).children('div.vboxVMListGroupVMs').children('table.vboxVMListVM').each(function(index, selm){
				var vmid = $(selm).data('vmid');
				if(vmid)
					groupDef.machines[groupDef.machines.length] = $(selm).data('vmid');
			});
		}
		
		// Remove any subgroups without machines or subgroups
		for(var i in groupDef.subgroups) {
			if(!groupDef.subgroups[i].subgroups.length && !groupDef.subgroups[i].machines.length) {
				$(elm).children('div.vboxVMListGroup').children('div.vboxVMListGroupHeader').children('span.vboxVMListGroupName:contains("'+groupDef.subgroups[i].name+'")').closest('div.vboxVMListGroup').remove();
				delete groupDef.subgroups[i];
			}
		}
		
		return groupDef;
		
	};

	/*
	 *
	 * Main run() function. Should only be called once. Though
	 * stop() and start() can be called many times.
	 *
	 */
	self.run = function() {
		
		if(self._running) return;

		// Subscribe to selected VM changes and refreshes
		$('#vboxIndex').bind('vmlistreload',function() {

			// Stop vmlist from refreshing..
			self.stop();

			// ask for new one
			vboxAjaxRequest('vboxGetMachines',{},function(d){
				self.start();
				self.updateList(d);
				if(svm) $('#vboxVMListItem-'+self.anchorid+'-'+svm).trigger('click');
			});
			
			
		}).bind('vmlistrefresh',function(){
			self.refresh();
		}).bind('hostChange',function(){
			self.selectedList = [];
			$('#vboxIndex').trigger('chooserSelectionChanged', [[]]);
			self.stop();
			
		}).bind('hostChanged',function(){

			// These may change based on host configuration
			self.enforceVMOwnership = $('#vboxIndex').data('vboxConfig').enforceVMOwnership;

			self.start();
		});
		
		/*
		 *
		 * VM List context menu items?
		 *
		 */
		if(self.vmContextMenuItems && self.vmContextMenuItems.length) {
			
			// Create context menu object
			self.contextMenuObj = new vboxMenu(self.anchorid);
			self.contextMenuObj.context = 'VBoxSelectorWnd';
			self.contextMenuObj.addMenu(self.vmContextMenuItems);
			
			// Update context menu when selected VM changes
			$('#vboxIndex').bind('chooserSelectionChanged',function(){
				var vm = vboxSelectionData.getSingleSelected();
				self.contextMenuObj.update(vm);
			});
		}
		
		/*
		 *
		 * Parent element context menu
		 *
		 */
		if(self.parentContextMenuItems && self.parentContextMenuItems.length) {

			var vboxVMListPaneMenu = new vboxMenu(self.anchorid+'Pane');
			vboxVMListPaneMenu.context = 'VBoxSelectorWnd';
			vboxVMListPaneMenu.addMenu(self.parentContextMenuItems);
	
			$('#'+self.anchorid).parent().contextMenu({
			  		menu: vboxVMListPaneMenu.menuId()
			  	},
			  	vboxVMListPaneMenu.menuClickCallback
			);
		
		}
		
		
		// Disable dragging selection, add dragging target class
		$(self.anchor).disableSelection().hover(function(){
			$(this).addClass('vboxVMListDropTargetHover');
		},function() {
			$(this).removeClass('vboxVMListDropTargetHover');
		});
		
		
		self.start();

	};
		
	/*
	 * Select a single item
	 */
	self.selectItem = function(e) {
		
		var selectedList = [];
		var item = $(this);
		
		// Group?
		if($(item).hasClass('vboxVMListGroupHeader')) {
			
			
			if(!e.ctrlKey) {
				self.anchor.find('.vboxListItemSelected').removeClass('vboxListItemSelected');
				self.anchor.find('div.vboxGroupSelected').removeClass('vboxGroupSelected');
			} else {
				selectedList = self.selectedList;
			}

			$(item).parent().addClass('vboxGroupSelected');
			
			selectedList[selectedList.length] = {
				type: 'group',
				groupPath: $(item).data('vmGroupPath')
			};
			
			
		// VM
		} else {
			
			if(!e.ctrlKey || $(item).data('vmid') == 'host') {
				
				self.anchor.find('.vboxListItemSelected').removeClass('vboxListItemSelected');
				self.anchor.find('div.vboxGroupSelected').removeClass('vboxGroupSelected');

			} else {
				selectedList = self.selectedList;
			}
			
			$(item).addClass('vboxListItemSelected').removeClass('vboxHover');
			
			selectedList[selectedList.length] = {
				type: 'vm',
				id: $(item).data('vmid'),
				groupPath: $(item).data('vmGroupPath')
			};
		}

		self.selectedList = selectedList;
		$('#vboxIndex').trigger('chooserSelectionChanged', [selectedList]);

		
	};
	
	/*
	 * Draw groups and place holders
	 */
	self.groupHTML = function(gdef, first) {
		
		var gHTML = $('<div />').append(
			$('<div />').addClass('vboxVMListGroupHeader').css({'display':(first ? 'none' : '')})
				.append(
						$('<div />').addClass('vboxVMListDropTargetHover').addClass('vboxDropTargetTop').hover(function(){
							if(self._draggingGroup)
								$(this).addClass('vboxHover')
						}, function(){
							$(this).removeClass('vboxHover')
						})
				)
				.data({'vmGroupPath':gdef.path})
				.append($('<span />').html(gdef.name).addClass('vboxVMListGroupName').attr({'title':gdef.name}))
				.append($('<span />').addClass('vboxVMListGroupInfo').html(
						(gdef.subgroups.length ? ('<img src="images/vbox/nw_16px.png" />'+gdef.subgroups.length) : '') +
						(gdef.machines.length ? (' <img src="images/vbox/fullscreen_16px.png" />'+gdef.machines.length) : '') +
						'' //'<img src="images/arrow_grad_up.png" />'
						))
				.hover(function(){
					$(this).addClass('vboxHover');
				},function(){
					$(this).removeClass('vboxHover');
				}).bind('click',self.selectItem)
				.draggable({'cursorAt':{left: -10, top: -10},'helper':function(){
					return $('<div />').append($(this).clone().removeClass('vboxHover')).addClass('vboxGroupSelected').css({'width':$(this).width()+'px','display':'inline'});
					},'start':function() {
						self._draggingGroup = true;
					},'stop':function() {
						
						self._draggingGroup = false;
						
						$(this).removeClass('vboxHover');
						
						var dropTarget = self.anchor.find('div.vboxHover').first();
						
						
						// Dropped onto a group
						if(dropTarget[0] && dropTarget.parent().hasClass('vboxVMListGroup')) {
							$(this).parent().detach().insertBefore(dropTarget.siblings('div.vboxVMListGroupVMs'));
						
						// Dropped onto main vm list
						} else if($(self.anchor).hasClass('vboxVMListDropTargetHover')) {
							$(this).parent().detach().insertBefore(self.anchor.children('div.vboxVMListGroup').children('div.vboxVMListGroupVMs'));
						}
						
						self.composeGroupDef();
						
				}})
				

			).addClass((first ? 'vboxVMlistGroupRoot' : '')).addClass('vboxVMListGroup');

		
		// Append sub-groups
		for(var i = 0; i < gdef.subgroups.length; i++) {
			gHTML.append(self.groupHTML(gdef.subgroups[i]));
		}
		
		// Append VM placeholders
		var vmlist = $('<div />').addClass('vboxVMListGroupVMs');
		if(gdef.machines.length) {
			for(var i = 0; i < gdef.machines.length; i++) {
				vmlist.append(
					$('<table />').addClass('vboxVMListItem-'+self.anchorid+'-'+gdef.machines[i]).data({'vmGroupPath':gdef.path})
				);
			}
		}
		
		return gHTML.append(vmlist);
		
		
	
	};
	
	/*
	 * Return vm data
	 */
	self.getVMData = function(vmid) {
		return self.vms[vmid];
	};
	
	/*
	 * Start VM list update
	 */ 
	self.start = function(noinit) {
		
		// already started
		if(self._running) return;
		
		var cb = function() {
			vboxAjaxRequest('vboxGetMachines',{},function(d) {
				self.updateList(d);
			});			
		};
		
		// noinit is passed by refresh() since it just
		// updated the list we don't need to immediately
		// refresh it again
		if(!noinit) cb();
		
		self._running = window.setInterval(cb,self.interval*1000);
		
		
	};
	
	/*
	 * Stop VM list updates and clear list
	 */
	self.stop = function() {
		if(!self._running) return;
		window.clearInterval(self._running);
		self._running = null;
		self.anchor.html("<div id='vboxVMListSpinner' style='text-align: center'><img src='images/spinner.gif' /></div>");
		self.vms = null;
		self.selectedList = [];
		$('#vboxIndex').trigger('chooserSelectionChanged',[[]]);
	};
	
	
	/* Force an imediate background refresh. Called when a VM
	 * attribute change is expected and we want it to show up
	 * asap.
	 */
	self.refresh = function() {
		
		// Stop refresh interval
		if(self._running)
			window.clearInterval(self._running);
		
		// If we happen to get data in the background,
		// ignore it because the update we're about to
		// perform will be more authoritative. See updateList()
		self._running = null;
		
		vboxAjaxRequest('vboxGetMachines',{},function(d) {
			self.start(true);
			self.updateList(d);
		});			
		
	};

}

</script>
